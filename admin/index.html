<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Judo Admin">
<meta name="description" content="DeLeon Judo Club - Admin">
<meta name="theme-color" content="#111111">
<link rel="icon" type="image/svg+xml" href="logo.svg">
<link rel="apple-touch-icon" href="logo.svg">
<title>DeLeon Judo Club – Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f0f0f0;
  --white: #fff;
  --text: #111;
  --text-mid: #444;
  --text-light: #777;
  --green: #16a34a;
  --green-row: #d6f5e0;
  --green-light: rgba(22,163,74,0.15);
  --green-mid: rgba(22,163,74,0.35);
  --red: #c41919;
  --divider: #e2e2e2;
  --font: 'Urbanist', sans-serif;

  /* past-date overrides */
  --past-bg: #111;
  --past-surface: #1a1a1a;
  --past-text: #ddd;
  --past-text-mid: #999;
  --past-text-light: #666;
  --past-divider: #333;
  --past-green-row: rgba(22,163,74,0.15);
}

body {
  font-family: var(--font);
  background: var(--white);
  color: var(--text);
  min-height: 100dvh;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
  padding-bottom: 90px;
}

/* ── Tab bar ── */
.tab-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--white);
  border-top: 1px solid var(--divider);
  display: flex;
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.tab {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 12px 0 10px;
  background: none;
  border: none;
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  color: var(--text-light);
  cursor: pointer;
  transition: color 0.15s;
}
.tab.active { color: var(--text); }
.tab svg { width: 26px; height: 26px; }
.tab.active svg { stroke-width: 2.5; }

/* ── Page containers ── */
.page { display: none; }
.page.active { display: flex; flex-direction: column; min-height: calc(100dvh - 90px - 45px); }
.si-past.page.active { background: var(--past-bg); }

/* ═══════════════════════════════════════════
   SIGN IN PAGE
   ═══════════════════════════════════════════ */
.si-header {
  background: var(--white);
  padding: 28px 24px 0;
  width: 100%;
  transition: background 0.25s, color 0.25s;
}

.si-brand {
  font-size: 13px; font-weight: 800;
  letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--red); text-align: center; margin-bottom: 8px;
}

.si-date-nav {
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 20px;
}

.si-arrow {
  background: none; border: none;
  font-size: 32px; font-weight: 300; color: var(--text-mid);
  cursor: pointer; padding: 8px 18px; line-height: 1;
  user-select: none; transition: color 0.15s;
}
.si-arrow:active { color: var(--text); }
.si-arrow:disabled { opacity: 0.25; cursor: default; }

.si-date-center { text-align: center; min-width: 170px; }

.si-date {
  font-size: 42px; font-weight: 900;
  letter-spacing: -0.03em; line-height: 1;
  transition: color 0.25s;
}

.si-weekday {
  font-size: 15px; font-weight: 600;
  color: var(--text-light); margin-top: 4px;
  transition: color 0.25s;
}

.si-date-tag {
  display: inline-block;
  font-size: 13px; font-weight: 800;
  letter-spacing: 0.1em; text-transform: uppercase;
  padding: 5px 14px; border-radius: 6px;
  margin-top: 8px;
}

.si-meta {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 0 20px;
}

.si-count {
  font-size: 18px; font-weight: 700; color: var(--text-mid);
  transition: color 0.25s;
}
.si-count .num { color: var(--green); }

.si-actions { display: flex; gap: 10px; }

.btn {
  font-family: var(--font); font-size: 14px; font-weight: 700;
  border: none; border-radius: 10px; cursor: pointer;
  padding: 10px 18px; transition: all 0.15s;
  text-decoration: none; display: inline-block;
}
.btn:active { transform: scale(0.97); }

.btn-outline {
  color: var(--text-mid); background: var(--bg);
  border: 1.5px solid var(--divider);
}

.btn-outline:hover { border-color: #aaa; }

/* Roster list */
.si-roster { background: var(--white); flex: 1; width: 100%; padding-bottom: 20px; transition: background 0.25s; }

.si-row {
  display: flex; align-items: center; gap: 14px;
  padding: 18px 20px;
  border-bottom: 1px solid var(--divider);
  cursor: pointer; user-select: none; -webkit-user-select: none;
  background: var(--white);
  transition: background 0.15s, border-color 0.25s;
}

.si-row:last-child { border-bottom: none; }
.si-row:active { opacity: 0.85; }

.si-row.present {
  background: var(--green-row);
  border-bottom-color: #c0e8cc;
}

.si-num {
  font-size: 14px; font-weight: 600; color: var(--text-light);
  min-width: 24px; text-align: right; flex-shrink: 0;
  transition: color 0.25s;
}

.si-name {
  font-size: 20px; font-weight: 700; flex: 1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: color 0.15s;
}
.si-row:not(.present) .si-name { color: var(--text-mid); }
.si-row.present .si-name { color: var(--text); }

.si-toggle {
  width: 56px; height: 32px; border-radius: 16px;
  background: #bbb; position: relative;
  transition: background 0.2s; flex-shrink: 0;
}
.si-toggle::after {
  content: ''; position: absolute;
  width: 26px; height: 26px; border-radius: 50%;
  background: #fff; top: 3px; left: 3px;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.si-row.present .si-toggle { background: var(--green); }
.si-row.present .si-toggle::after { transform: translateX(24px); }

/* Past-date mode */
.si-past .si-header { background: var(--past-bg); }
.si-past .si-brand { color: #e87070; }
.si-past .si-date { color: var(--past-text); }
.si-past .si-weekday { color: var(--past-text-light); }
.si-past .si-count { color: var(--past-text-mid); }
.si-past .si-arrow { color: var(--past-text-mid); }
.si-past .si-roster { background: var(--past-bg); }
.si-past .si-row { background: var(--past-bg); border-bottom-color: var(--past-divider); }
.si-past .si-row.present { background: var(--past-green-row); border-bottom-color: rgba(22,163,74,0.15); }
.si-past .si-row:not(.present) .si-name { color: var(--past-text-mid); }
.si-past .si-row.present .si-name { color: var(--past-text); }
.si-past .si-num { color: var(--past-text-light); }
.si-past .si-toggle { background: #555; }
.si-past .si-row.present .si-toggle { background: var(--green); }
.si-past .btn-outline { background: var(--past-divider); border-color: #444; color: var(--past-text-mid); }

/* Dark tab bar in past mode */
body.past-mode { background: #111; }
body.past-mode .tab-bar {
  background: #111;
  border-top-color: #333;
}
body.past-mode .tab { color: #555; }
body.past-mode .tab.active { color: #ccc; }

/* Cancelled-day mode */
.si-cancelled .si-roster { opacity: 0.3; pointer-events: none; }
.si-cancelled .si-count { display: none; }
.si-cancelled #siToggleAll { display: none; }

.si-cancelled-banner {
  display: none;
  font-size: 15px; font-weight: 800;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--red); padding: 0 2px;
}
.si-cancelled .si-cancelled-banner { display: block; }

.btn-cancel-active {
  color: var(--red) !important;
  border-color: var(--red) !important;
  background: rgba(196,25,25,0.06) !important;
}

/* Future-date mode */
.si-future .si-date-tag { background: #e0e7ff; color: #4338ca; }

/* ═══════════════════════════════════════════
   ROSTER PAGE
   ═══════════════════════════════════════════ */
.ro-header {
  background: var(--white);
  padding: 28px 24px 20px;
}

.ro-title {
  font-size: 28px; font-weight: 900; margin-bottom: 4px;
}

.ro-subtitle {
  font-size: 15px; font-weight: 600; color: var(--text-light);
  margin-bottom: 20px;
}

.btn-green {
  color: #fff; background: var(--green);
}

.ro-list { background: var(--white); flex: 1; padding-bottom: 20px; }

.ro-add-btn {
  width: 100%; padding: 16px; font-size: 17px; text-align: center;
  border-radius: 12px;
}

.ro-field {
  text-align: left; margin-bottom: 16px;
}

.ro-label {
  display: block; font-size: 13px; font-weight: 700;
  color: var(--text-light); text-transform: uppercase;
  letter-spacing: 0.06em; margin-bottom: 6px;
}

.ro-modal-input {
  width: 100%; font-family: var(--font);
  font-size: 18px; font-weight: 600;
  padding: 14px 16px; border-radius: 12px;
  border: 1.5px solid var(--divider);
  background: var(--bg); color: var(--text);
  outline: none; transition: border-color 0.15s;
}
.ro-modal-input:focus { border-color: var(--green); }
.ro-modal-input::placeholder { color: #bbb; }
.ro-modal-input.error { border-color: var(--red); }

.ro-row {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--divider);
}
.ro-row:last-child { border-bottom: none; }

.ro-num {
  font-size: 14px; font-weight: 600; color: var(--text-light);
  min-width: 24px; text-align: right; flex-shrink: 0;
}

.ro-name {
  font-size: 18px; font-weight: 700; flex: 1; color: var(--text);
}

.ro-edit {
  background: none; border: none; cursor: pointer;
  font-size: 17px; color: #ccc; padding: 4px 8px;
  transition: color 0.15s; border-radius: 6px;
}
.ro-edit:hover { color: var(--text); }
.ro-edit:active { background: rgba(0,0,0,0.06); }

.ro-delete {
  background: none; border: none; cursor: pointer;
  font-size: 18px; color: #ccc; padding: 4px 8px;
  transition: color 0.15s; border-radius: 6px;
}
.ro-delete:hover { color: var(--red); }
.ro-delete:active { background: rgba(196,25,25,0.08); }

/* Status badges */
.ro-status {
  font-size: 11px; font-weight: 700; padding: 3px 9px;
  border-radius: 20px; border: 1.5px solid transparent;
  white-space: nowrap; flex-shrink: 0; cursor: pointer;
}
.ro-status-active   { background:#d6f5e0; color:#16a34a; border-color:#86efac; }
.ro-status-inactive { background:#f0f0f0; color:#777;    border-color:#ccc; }
.ro-status-teacher  { background:#e0e7ff; color:#4338ca; border-color:#a5b4fc; }

/* Belt badges (Roster + Rank) */
.rk-belt-badge {
  display: inline-block;
  font-size: 11px; font-weight: 800;
  letter-spacing: 0.04em; text-transform: uppercase;
  padding: 3px 8px; border-radius: 20px;
  border: 1.5px solid transparent;
  flex-shrink: 0; white-space: nowrap;
}

/* Status sheet overlay */
.ro-status-modal {
  max-width: 320px;
}
.ro-status-name {
  font-size: 18px; font-weight: 800; margin-bottom: 20px; text-align: center;
}
.ro-status-options { display: flex; flex-direction: column; gap: 2px; margin-bottom: 8px; }
.ro-status-option {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; border-radius: 12px; cursor: pointer;
  font-size: 16px; font-weight: 600; border: none; background: none;
  font-family: var(--font); width: 100%; text-align: left;
  transition: background 0.12s;
}
.ro-status-option:hover { background: var(--bg); }
.ro-status-option.selected { background: var(--bg); }
.ro-status-option .ro-status-dot {
  width: 18px; height: 18px; border-radius: 50%;
  border: 2px solid #ccc; flex-shrink: 0;
}
.ro-status-option.selected .ro-status-dot {
  background: var(--green); border-color: var(--green);
}

/* Rank page */
.rk-header {
  background: var(--white);
  padding: 28px 24px 20px;
}
.rk-title-row {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;
}
.rk-title { font-size: 28px; font-weight: 900; }
.rk-subtitle { font-size: 14px; color: var(--text-light); font-weight: 600; margin-bottom: 16px; }

.rk-row {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 20px; border-bottom: 1px solid var(--divider);
  cursor: pointer; transition: background 0.1s;
}
.rk-row:active { background: var(--bg); }
.rk-row-name { flex: 1; min-width: 0; font-size: 16px; font-weight: 700; }
.rk-row-right { text-align: right; flex-shrink: 0; }
.rk-row-grade { font-size: 13px; font-weight: 700; color: var(--text); }
.rk-row-date { font-size: 12px; color: var(--text-light); font-weight: 600; margin-top: 2px; }

/* Rank profile sheet */
.rk-profile-overlay {
  position: fixed; inset: 0; z-index: 400;
  background: rgba(0,0,0,0.45);
  display: flex; align-items: flex-end;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.rk-profile-overlay.show { opacity: 1; pointer-events: auto; }
.rk-profile-sheet {
  background: var(--white); border-radius: 20px 20px 0 0;
  width: 100%; max-height: 88dvh;
  display: flex; flex-direction: column; overflow: hidden;
  transform: translateY(100%); transition: transform 0.25s cubic-bezier(.32,1,.23,1);
}
.rk-profile-overlay.show .rk-profile-sheet { transform: translateY(0); }

.rk-profile-header {
  display: flex; align-items: center; gap: 12px;
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--divider); flex-shrink: 0;
}
.rk-profile-header-name { flex: 1; font-size: 19px; font-weight: 800; }
.rk-profile-close {
  background: none; border: none; cursor: pointer;
  font-size: 20px; color: var(--text-light); padding: 4px 8px; border-radius: 6px;
}
.rk-profile-close:active { background: var(--bg); }

.rk-profile-fields {
  overflow-y: auto; padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 16px;
}
.rk-profile-section-title {
  font-size: 11px; font-weight: 800; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--text-light);
  margin-bottom: -4px;
}
.rk-profile-actions {
  display: flex; gap: 12px; padding: 16px 20px;
  border-top: 1px solid var(--divider); flex-shrink: 0;
}

/* ═══════════════════════════════════════════
   STATS PAGE
   ═══════════════════════════════════════════ */
.st-header {
  background: var(--white);
  padding: 28px 24px 20px;
}

.st-title-row {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
}

.st-title {
  font-size: 28px; font-weight: 900;
}

.st-export-btn {
  background: none; border: 1px solid var(--border); border-radius: 8px;
  padding: 6px 12px; font-family: var(--font); font-size: 13px; font-weight: 600;
  color: var(--text-light); cursor: pointer; display: flex; align-items: center; gap: 6px;
  transition: all 0.15s;
}
.st-export-btn:hover { color: var(--text); border-color: #bbb; }

.st-view-toggle {
  display: flex; gap: 2px; background: var(--bg);
  border-radius: 12px; padding: 4px; margin-bottom: 12px;
}
.st-day-filter {
  display: flex; align-items: center; padding: 0 4px; margin-bottom: 16px;
}

.st-view-btn {
  font-family: var(--font); font-size: 15px; font-weight: 700;
  padding: 12px 16px; border: none; border-radius: 10px;
  background: transparent; color: var(--text-light);
  cursor: pointer; flex: 1; text-align: center;
  transition: all 0.15s;
}
.st-view-btn.active {
  background: var(--white); color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.st-nav {
  display: flex; align-items: center; justify-content: center;
}

.st-arrow {
  background: none; border: none;
  font-size: 28px; font-weight: 300; color: var(--text-mid);
  cursor: pointer; padding: 4px 14px; line-height: 1;
}
.st-arrow:disabled { opacity: 0.25; cursor: default; }

.st-nav-center { text-align: center; min-width: 200px; }

.st-nav-label {
  font-size: 22px; font-weight: 800; text-transform: uppercase;
}

.st-nav-range {
  font-size: 13px; font-weight: 600; color: var(--text-light);
  margin-top: 2px;
}

/* Cards */
.st-cards {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 10px; padding: 20px;
}

.st-card {
  background: var(--white); border-radius: 14px;
  padding: 20px; border: 1px solid var(--divider);
}

.st-card-label {
  font-size: 14px; font-weight: 700; color: var(--text-light);
  text-transform: uppercase; letter-spacing: 0.06em;
  margin-bottom: 6px;
}

.st-card-value {
  font-size: 32px; font-weight: 900;
}

.st-card-delta {
  font-size: 14px; font-weight: 700; margin-top: 4px;
}
.st-card-delta.up { color: var(--green); }
.st-card-delta.down { color: var(--red); }
.st-card-delta.flat { color: var(--text-light); }

/* Trend bars */
.st-trend { padding: 20px; }

.st-section-title {
  font-size: 16px; font-weight: 700; color: var(--text-light);
  text-transform: uppercase; letter-spacing: 0.06em;
  margin-bottom: 14px;
}

.st-chart {
  display: flex; align-items: flex-end; gap: 3px; height: 100px;
}

.st-bar {
  flex: 1; background: var(--green-light);
  border-radius: 4px 4px 0 0; min-height: 4px;
  position: relative; transition: height 0.3s;
}
.st-bar:hover { background: var(--green-mid); }
.st-bar:hover::after {
  content: attr(data-tip); position: absolute;
  bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  background: var(--text); color: #fff;
  font-size: 12px; font-weight: 600;
  padding: 5px 10px; border-radius: 6px;
  white-space: nowrap; z-index: 10;
}

.st-labels {
  display: flex; gap: 3px; padding-top: 6px;
}
.st-label {
  flex: 1; text-align: center;
  font-size: 13px; font-weight: 600; color: var(--text-light);
}

/* Per-student table */
.st-table { padding: 10px 20px 20px; }

.st-table-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}

.st-sort-btn {
  font-family: var(--font); font-size: 15px; font-weight: 700;
  color: var(--text-light); background: var(--white);
  border: 1.5px solid var(--divider); border-radius: 10px;
  padding: 10px 16px; cursor: pointer;
}

.st-student-row {
  display: flex; align-items: center;
  padding: 18px 0; border-bottom: 1px solid var(--divider);
}
.st-student-row:last-child { border-bottom: none; }

.st-student-name {
  font-size: 19px; font-weight: 700;
  min-width: 0; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
  flex: 1;
}

.st-bar-wrap {
  flex: 0.7; height: 12px; background: var(--bg);
  border-radius: 6px; margin: 0 14px; overflow: hidden;
}
.st-bar-fill {
  height: 100%; background: var(--green);
  border-radius: 6px; transition: width 0.4s;
}

.st-student-count {
  font-size: 19px; font-weight: 800; min-width: 60px; text-align: right;
  color: var(--text);
}

.st-student-pct {
  font-size: 15px; font-weight: 700; color: var(--text-light);
  min-width: 48px; text-align: right;
}

.st-student-lastseen {
  font-size: 14px; font-weight: 600; color: var(--text-light);
  min-width: 62px; text-align: right; padding-left: 10px;
}

.st-student-row--absent {
  background: rgba(196, 25, 25, 0.06);
  border-radius: 8px;
  margin: 0 -8px; padding-left: 8px; padding-right: 8px;
}
.st-student-row--absent .st-student-lastseen {
  color: var(--red); font-weight: 700;
}

.st-section-title--inline { margin: 0; }


/* Empty */
.st-empty {
  text-align: center; padding: 60px 20px;
  color: var(--text-light); font-size: 17px; font-weight: 600;
}

/* ═══════════════════════════════════════
   DUES PAGE
   ═══════════════════════════════════════ */
.du-header {
  background: var(--white);
  padding: 28px 24px 20px;
}
.du-title-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.du-title {
  font-size: 28px; font-weight: 900;
}

/* Toggle switch */
.du-toggle {
  display: flex; align-items: center; gap: 10px; cursor: pointer;
}
.du-toggle input { display: none; }
.du-toggle-slider {
  width: 44px; height: 24px; background: var(--divider);
  border-radius: 12px; position: relative; transition: background 0.2s;
}
.du-toggle-slider::after {
  content: ''; position: absolute; top: 2px; left: 2px;
  width: 20px; height: 20px; background: var(--white);
  border-radius: 50%; transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.du-toggle input:checked + .du-toggle-slider {
  background: var(--green);
}
.du-toggle input:checked + .du-toggle-slider::after {
  transform: translateX(20px);
}
.du-toggle-label {
  font-size: 14px; font-weight: 700; color: var(--text-light);
}

/* Summary bar */
.du-summary {
  padding: 20px; display: flex; align-items: center; gap: 16px;
}
.du-summary-text {
  font-size: 16px; font-weight: 700; color: var(--text);
  white-space: nowrap;
}
.du-summary-bar {
  flex: 1; height: 12px; background: var(--bg);
  border-radius: 6px; overflow: hidden;
}
.du-summary-fill {
  height: 100%; background: var(--green);
  border-radius: 6px; transition: width 0.4s;
}

/* Student rows */
.du-list { padding: 0 20px 20px; }

.du-row {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 0; border-bottom: 1px solid var(--divider);
  cursor: pointer;
}
.du-row:last-child { border-bottom: none; }
.du-row:active { background: var(--bg); }

.du-name {
  flex: 1; font-size: 17px; font-weight: 700;
  min-width: 0; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
}

.du-badge {
  font-size: 13px; font-weight: 800; padding: 4px 12px;
  border-radius: 20px; text-transform: uppercase; letter-spacing: 0.04em;
}
.du-badge--paid { background: var(--green-row); color: var(--green); }
.du-badge--unpaid { background: rgba(196,25,25,0.08); color: var(--red); }

.du-date {
  font-size: 14px; font-weight: 600; color: var(--text-light);
  min-width: 60px; text-align: right;
}

.du-overdue {
  font-size: 12px; font-weight: 800; color: var(--red);
  white-space: nowrap;
}

/* ── Modal ── */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 400; display: flex; align-items: center; justify-content: center;
  padding: 24px; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.show { opacity: 1; pointer-events: auto; }

.modal {
  background: var(--white); border-radius: 20px;
  padding: 32px 24px 24px; width: 100%; max-width: 400px;
  text-align: center;
}

.modal-title {
  font-size: 24px; font-weight: 800; margin-bottom: 10px;
}

.modal-body {
  font-size: 17px; font-weight: 500; color: var(--text-mid);
  margin-bottom: 28px; line-height: 1.5;
}

.modal-actions {
  display: flex; gap: 12px;
}

.modal-btn {
  flex: 1; font-family: var(--font); font-size: 17px; font-weight: 700;
  padding: 18px 0; border-radius: 14px; border: none; cursor: pointer;
  transition: all 0.15s;
}
.modal-btn:active { transform: scale(0.97); }

.modal-cancel {
  background: var(--bg); color: var(--text-mid);
}

.modal-danger {
  background: var(--red); color: #fff;
}
/* ── PIN Screen ── */
.pin-screen {
  position: fixed; inset: 0; z-index: 500;
  background: #0a0a0a;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 24px;
  transition: opacity 0.3s, transform 0.3s;
}
.pin-screen.hidden {
  opacity: 0; pointer-events: none; transform: scale(1.02);
}

.pin-brand {
  font-size: 13px; font-weight: 800;
  letter-spacing: 0.2em; text-transform: uppercase;
  color: rgba(255,255,255,0.25); margin-bottom: 40px;
}

.pin-title {
  font-size: 26px; font-weight: 800; color: #fff;
  margin-bottom: 8px;
}

.pin-subtitle {
  font-size: 15px; font-weight: 500; color: rgba(255,255,255,0.35);
  margin-bottom: 36px;
}

.pin-dots {
  display: flex; gap: 16px; margin-bottom: 44px;
}

.pin-dot {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2.5px solid rgba(255,255,255,0.2);
  transition: all 0.15s;
}
.pin-dot.filled {
  background: #fff; border-color: #fff;
}
.pin-dot.error {
  border-color: var(--red); background: var(--red);
}

.pin-pad {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 14px; width: 100%; max-width: 300px;
}

.pin-key {
  font-family: var(--font);
  font-size: 30px; font-weight: 700; color: #fff;
  background: rgba(255,255,255,0.07);
  border: none; border-radius: 18px;
  aspect-ratio: 1.3;
  cursor: pointer; transition: background 0.1s;
  user-select: none; -webkit-user-select: none;
  display: flex; align-items: center; justify-content: center;
}
.pin-key:active { background: rgba(255,255,255,0.18); }

.pin-key-empty {
  background: transparent !important; cursor: default;
}

.pin-key-back {
  font-size: 22px;
  background: rgba(255,255,255,0.04);
}

.pin-error-msg {
  color: var(--red); font-size: 15px; font-weight: 700;
  margin-top: 24px; min-height: 22px;
}

/* ── Sync status bar ── */
.si-sync {
  display: flex; align-items: center; gap: 10px;
  padding: 14px 24px; width: 100%;
  font-size: 16px; font-weight: 700;
  color: var(--text-light);
  background: var(--white);
  border-bottom: 1px solid var(--divider);
}

.si-sync-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  transition: background 0.2s;
}
.si-sync-dot.green { background: var(--green); }
.si-sync-dot.yellow { background: #eab308; }
.si-sync-dot.red { background: var(--red); }

.si-sync-text { flex: 1; }
.si-sync-version { font-size: 13px; font-weight: 500; color: #bbb; }

.si-sync-refresh {
  background: none; border: none; cursor: pointer;
  color: #bbb; padding: 4px; border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: color 0.15s;
}
.si-sync-refresh:hover { color: var(--text-light); }
.si-sync-refresh:active { color: var(--text); }
.si-sync-refresh svg { width: 16px; height: 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.si-sync-refresh.spinning svg { animation: spin 0.7s linear infinite; }

.si-sync-retry {
  font-family: var(--font); font-size: 15px; font-weight: 700;
  color: var(--red); background: rgba(196,25,25,0.06);
  border: 1px solid rgba(196,25,25,0.2);
  cursor: pointer; padding: 8px 16px; display: none;
  border-radius: 8px;
}
.si-sync-retry:active { background: rgba(196,25,25,0.12); }

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}
.si-sync.saving .si-sync-dot { animation: pulse-dot 0.8s ease infinite; }
.si-sync.retrying .si-sync-dot { animation: pulse-dot 1.2s ease infinite; }
.si-sync.error .si-sync-retry { display: block; }

/* past mode sync bar */
body.past-mode .si-sync {
  background: var(--past-bg); color: var(--past-text-light);
  border-bottom-color: var(--past-divider);
}
body.past-mode .si-sync-retry { color: #f87171; background: rgba(248,113,113,0.1); border-color: rgba(248,113,113,0.2); }

.toast {
  position: fixed; bottom: 100px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  font-family: var(--font); font-size: 16px; font-weight: 700;
  padding: 16px 28px; border-radius: 14px;
  opacity: 0; transition: all 0.3s; z-index: 300;
  pointer-events: none;
  display: flex; align-items: center; gap: 10px;
  min-width: 200px; justify-content: center;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.toast-saved {
  background: var(--green); color: #fff;
}
.toast-pending {
  background: var(--text); color: #fff;
}
.toast-error {
  background: var(--red); color: #fff;
  pointer-events: auto; cursor: pointer;
}

.toast-icon {
  font-size: 20px; line-height: 1;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
.toast-spinner {
  width: 18px; height: 18px;
  border: 2.5px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

/* ── Pull to Refresh ── */
.ptr {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  z-index: 50;
  pointer-events: none;
}
.ptr__indicator {
  background: var(--white);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transform: translateY(-50px);
  transition: transform 0.2s ease;
}
.ptr__indicator svg {
  width: 20px;
  height: 20px;
  stroke: var(--text);
  fill: none;
  stroke-width: 2.5;
  stroke-linecap: round;
}
.ptr--loading .ptr__indicator {
  transform: translateY(16px);
}
.ptr--loading .ptr__indicator svg {
  animation: ptr-spin 0.8s linear infinite;
}
@keyframes ptr-spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="ptr" id="ptr">
  <div class="ptr__indicator">
    <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.22-8.56"/><polyline points="21 3 21 9 15 9"/></svg>
  </div>
</div>

<div class="pin-screen" id="pinScreen">
  <div class="pin-brand">Club Sign In</div>
  <div class="pin-title">Enter PIN</div>
  <div class="pin-subtitle">4-digit access code</div>
  <div class="pin-dots">
    <div class="pin-dot" id="dot0"></div>
    <div class="pin-dot" id="dot1"></div>
    <div class="pin-dot" id="dot2"></div>
    <div class="pin-dot" id="dot3"></div>
  </div>
  <div class="pin-pad">
    <button class="pin-key" onclick="pinPress('1')">1</button>
    <button class="pin-key" onclick="pinPress('2')">2</button>
    <button class="pin-key" onclick="pinPress('3')">3</button>
    <button class="pin-key" onclick="pinPress('4')">4</button>
    <button class="pin-key" onclick="pinPress('5')">5</button>
    <button class="pin-key" onclick="pinPress('6')">6</button>
    <button class="pin-key" onclick="pinPress('7')">7</button>
    <button class="pin-key" onclick="pinPress('8')">8</button>
    <button class="pin-key" onclick="pinPress('9')">9</button>
    <button class="pin-key pin-key-empty"></button>
    <button class="pin-key" onclick="pinPress('0')">0</button>
    <button class="pin-key pin-key-back" onclick="pinBack()">&#8592;</button>
  </div>
  <div class="pin-error-msg" id="pinError"></div>
</div>

<!-- ════ GLOBAL SYNC BAR ════ -->
<div class="si-sync" id="siSync">
  <div class="si-sync-dot green" id="siSyncDot"></div>
  <div class="si-sync-text" id="siSyncText">All saved</div>
  <button class="si-sync-retry" id="siSyncRetry" onclick="siRetrySync()">Retry</button>
  <div class="si-sync-version" id="siSyncVersion"></div>
  <button class="si-sync-refresh" id="siSyncRefresh" aria-label="Refresh data">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 4 23 10 17 10"></polyline>
      <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
    </svg>
  </button>
</div>

<!-- ════ SIGN IN PAGE ════ -->
<div class="page active" id="page-signin">
  <div class="si-header">
    <div class="si-brand">Club Sign In</div>
    <div class="si-date-nav">
      <button class="si-arrow" id="siPrev" onclick="siNav(-1)">&#8249;</button>
      <div class="si-date-center">
        <div class="si-date" id="siDate"></div>
        <div class="si-weekday" id="siWeekday"></div>
        <div id="siTag"></div>
      </div>
      <button class="si-arrow" id="siNext" onclick="siNav(1)">&#8250;</button>
    </div>
    <div class="si-meta">
      <div class="si-count" id="siCount"></div>
      <div class="si-cancelled-banner">Class Cancelled</div>
      <div class="si-actions">
        <button class="btn btn-outline" id="siCancelBtn" onclick="siToggleCancel()">Cancel class</button>
        <button class="btn btn-outline" id="siToggleAll" onclick="siToggleAll()">Clear all</button>
      </div>
    </div>
  </div>
  <div class="si-roster" id="siRoster"></div>
</div>

<!-- ════ ROSTER PAGE ════ -->
<div class="page" id="page-roster">
  <div class="ro-header">
    <div class="ro-title">Roster</div>
    <div class="ro-subtitle" id="roSubtitle"></div>
    <button class="btn btn-green ro-add-btn" onclick="roShowAdd()">+ Add Student</button>
  </div>
  <div class="ro-list" id="roList"></div>
</div>

<!-- Add student modal -->
<div class="modal-overlay" id="roAddOverlay" onclick="roCloseAdd()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title" id="roAddTitle">Add Student</div>
    <div class="modal-body" id="roAddBody">
      <div class="ro-field">
        <label class="ro-label">First name</label>
        <input class="ro-modal-input" id="roFirstName" type="text" placeholder="e.g. Yuki" autocomplete="off" autocorrect="off" autocapitalize="words" spellcheck="false" data-form-type="other" data-lpignore="true">
      </div>
      <div class="ro-field">
        <label class="ro-label">Last name</label>
        <input class="ro-modal-input" id="roLastName" type="text" placeholder="e.g. Tanaka" autocomplete="off" autocorrect="off" autocapitalize="words" spellcheck="false" data-form-type="other" data-lpignore="true">
      </div>
    </div>
    <div class="modal-actions" id="roAddActions">
      <button class="modal-btn modal-cancel" onclick="roCloseAdd()">Cancel</button>
      <button class="modal-btn btn-green" id="roAddBtn" onclick="editingStudent ? roEditConfirm() : roAddConfirm()">Add</button>
    </div>
    <!-- Success state -->
    <div id="roAddSuccess" style="display:none; text-align:center; padding: 10px 0;">
      <div style="font-size:40px; margin-bottom:12px;">&#10003;</div>
      <div style="font-size:18px; font-weight:700; margin-bottom:4px;" id="roAddSuccessName"></div>
      <div style="font-size:14px; color:var(--text-light); font-weight:600;" id="roAddSuccessMsg">Added to roster</div>
    </div>
  </div>
</div>

<!-- ════ RANK PAGE ════ -->
<div class="page" id="page-rank">
  <div class="rk-header">
    <div class="rk-title-row">
      <div class="rk-title">Rank</div>
    </div>
    <div class="rk-subtitle" id="rkSubtitle"></div>
  </div>
  <div id="rkList"></div>
</div>

<!-- Rank profile sheet -->
<div class="rk-profile-overlay" id="rkProfileOverlay" onclick="rkProfileClose()">
  <div class="rk-profile-sheet" onclick="event.stopPropagation()">
    <div class="rk-profile-header">
      <div id="rkProfileBadge"></div>
      <div class="rk-profile-header-name" id="rkProfileName"></div>
      <button class="rk-profile-close" onclick="rkProfileClose()">&#10005;</button>
    </div>
    <div class="rk-profile-fields" id="rkProfileFields">
      <div class="rk-profile-section-title">Division</div>
      <div class="ro-field">
        <label class="ro-label">Division</label>
        <select class="ro-modal-input" id="rkDivision" onchange="rkDivisionChange()">
          <option value="">— not set —</option>
          <option value="junior">Junior (16 &amp; under)</option>
          <option value="senior">Senior (17+)</option>
        </select>
      </div>
      <div class="rk-profile-section-title" style="margin-top:4px">Rank</div>
      <div class="ro-field">
        <label class="ro-label">Grade</label>
        <select class="ro-modal-input" id="rkGrade" onchange="rkGradeChange()">
          <option value="">— select division first —</option>
        </select>
      </div>
      <div class="ro-field">
        <label class="ro-label">Date of Last Promotion</label>
        <input class="ro-modal-input" id="rkPromotionDate" type="date">
      </div>
      <div class="rk-profile-section-title" style="margin-top:4px">Memberships</div>
      <div class="ro-field">
        <label class="ro-label">USJF Membership #</label>
        <input class="ro-modal-input" id="rkUsjf" type="text" placeholder="Required" inputmode="numeric" autocomplete="off">
      </div>
      <div class="ro-field" style="display:none">
        <label class="ro-label">USJA Membership # <span style="font-weight:500;color:var(--text-light)">(optional)</span></label>
        <input class="ro-modal-input" id="rkUsja" type="text" inputmode="numeric" autocomplete="off">
      </div>
      <div class="ro-field" style="display:none">
        <label class="ro-label">USA Judo # <span style="font-weight:500;color:var(--text-light)">(optional — national/intl)</span></label>
        <input class="ro-modal-input" id="rkUsaj" type="text" inputmode="numeric" autocomplete="off">
      </div>
      <div class="ro-field">
        <label class="ro-label">Join Date <span style="font-weight:500;color:var(--text-light)">(optional)</span></label>
        <input class="ro-modal-input" id="rkJoinDate" type="date">
      </div>
    </div>
    <div class="rk-profile-actions">
      <button class="modal-btn modal-cancel" onclick="rkProfileClose()">Cancel</button>
      <button class="modal-btn btn-green" onclick="rkProfileSave()">Save</button>
    </div>
  </div>
</div>

<!-- Status sheet -->
<div class="modal-overlay" id="roStatusOverlay" onclick="roStatusClose()">
  <div class="modal ro-status-modal" onclick="event.stopPropagation()">
    <div class="modal-title ro-status-name" id="roStatusName"></div>
    <div class="ro-status-options">
      <button class="ro-status-option" id="roStatusOptActive" onclick="roStatusSelect('active')">
        <span class="ro-status-dot"></span> Active
      </button>
      <button class="ro-status-option" id="roStatusOptInactive" onclick="roStatusSelect('inactive')">
        <span class="ro-status-dot"></span> Inactive
      </button>
      <button class="ro-status-option" id="roStatusOptTeacher" onclick="roStatusSelect('teacher')">
        <span class="ro-status-dot"></span> Teacher
      </button>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-cancel" onclick="roStatusClose()">Cancel</button>
      <button class="modal-btn btn-green" onclick="roStatusSave()">Save</button>
    </div>
  </div>
</div>

<!-- ════ STATS PAGE ════ -->
<div class="page" id="page-stats">
  <div class="st-header">
    <div class="st-title-row">
      <div class="st-title">Stats</div>
      <button class="st-export-btn" onclick="exportAttendanceCSV()" aria-label="Export attendance CSV">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export CSV
      </button>
    </div>
    <div class="st-view-toggle">
      <button class="st-view-btn active" id="stDayBtn" onclick="stSetView('day')">Day</button>
      <button class="st-view-btn" id="stMonthBtn" onclick="stSetView('month')">Month</button>
    </div>
    <div class="st-day-filter" id="stDayFilter">
      <label class="du-toggle">
        <input type="checkbox" id="stClassDaysOnly">
        <span class="du-toggle-slider"></span>
        <span class="du-toggle-label">Class days only</span>
      </label>
    </div>
    <div class="st-nav">
      <button class="st-arrow" id="stPrev" onclick="stNav(-1)">&#8249;</button>
      <div class="st-nav-center">
        <div class="st-nav-label" id="stNavLabel"></div>
        <div class="st-nav-range" id="stNavRange"></div>
      </div>
      <button class="st-arrow" id="stNext" onclick="stNav(1)">&#8250;</button>
    </div>
  </div>
  <div id="stContent"></div>
</div>

<!-- ════ DUES PAGE ════ -->
<div class="page" id="page-dues">
  <div class="du-header">
    <div class="du-title-row">
      <div class="du-title">Dues</div>
      <label class="du-toggle">
        <input type="checkbox" id="duesEnabledToggle" checked>
        <span class="du-toggle-slider"></span>
        <span class="du-toggle-label">Reminders</span>
      </label>
    </div>
    <div class="st-nav">
      <button class="st-arrow" id="duPrev" onclick="duNav(-1)">&#8249;</button>
      <div class="st-nav-center">
        <div class="st-nav-label" id="duNavLabel"></div>
      </div>
      <button class="st-arrow" id="duNext" onclick="duNav(1)">&#8250;</button>
    </div>
  </div>
  <div id="duContent"></div>
</div>

<!-- ════ TAB BAR ════ -->
<nav class="tab-bar">
  <button class="tab active" onclick="switchTab('signin')" id="tab-signin">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Sign In
  </button>
  <button class="tab" onclick="switchTab('roster')" id="tab-roster">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Roster
  </button>
  <button class="tab" onclick="switchTab('rank')" id="tab-rank">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
    Rank
  </button>
  <button class="tab" onclick="switchTab('stats')" id="tab-stats">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="8" width="4" height="13"/><rect x="17" y="3" width="4" height="18"/></svg>
    Stats
  </button>
  <button class="tab" onclick="switchTab('dues')" id="tab-dues">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    Dues
  </button>
</nav>

<div class="modal-overlay" id="modalOverlay" onclick="modalClose()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title" id="modalTitle">Confirm</div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-btn modal-cancel" onclick="modalClose()">Cancel</button>
      <button class="modal-btn modal-danger" id="modalConfirm">Remove</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════
// SHARED STATE & HELPERS
// ═══════════════════════════════════
const APP_VERSION = 'v1.4';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJkdlFVVemzTplXx-6oA3c3EAcrhwjV6eCYe011gWj62DLBImc2WE29mRc4s828kCFMA/exec';
const WRITE_KEY = '1970';

const CLASS_DAYS = [2, 4]; // Tue, Thu (graded days)
// const CLASS_DAYS = [1, 2, 4]; // Mon, Tue, Thu — uncomment to include Monday open mat
const DEFAULT_ROSTER = [];

function getRoster() {
  try {
    var r = localStorage.getItem('dojo_roster');
    if (r) return JSON.parse(r);
    localStorage.setItem('dojo_roster', JSON.stringify(DEFAULT_ROSTER));
    return DEFAULT_ROSTER.slice();
  } catch (e) {
    return DEFAULT_ROSTER.slice();
  }
}
function setRoster(r) {
  try { localStorage.setItem('dojo_roster', JSON.stringify(r)); }
  catch (e) {}
}
function getAtt() {
  try { return JSON.parse(localStorage.getItem('dojo_attendance') || '{}'); }
  catch (e) { return {}; }
}
function setAtt(a) {
  try { localStorage.setItem('dojo_attendance', JSON.stringify(a)); }
  catch (e) {}
}
function getRemoved() {
  try { return JSON.parse(localStorage.getItem('dojo_removed') || '{}'); }
  catch (e) { return {}; }
}
function setRemoved(r) {
  try { localStorage.setItem('dojo_removed', JSON.stringify(r)); }
  catch (e) {}
}
function getCancelled() {
  try { return JSON.parse(localStorage.getItem('dojo_cancelled') || '[]'); }
  catch (e) { return []; }
}
function setCancelled(c) {
  try { localStorage.setItem('dojo_cancelled', JSON.stringify(c)); }
  catch (e) {}
}
function getStudentProfiles() {
  try { return JSON.parse(localStorage.getItem('dojo_student_profiles') || '{}'); }
  catch (e) { return {}; }
}
function setStudentProfiles(obj) {
  try { localStorage.setItem('dojo_student_profiles', JSON.stringify(obj)); }
  catch (e) {}
}
function getStudentProfile(name) { return getStudentProfiles()[name] || {}; }
function setStudentProfile(name, data) {
  var obj = getStudentProfiles();
  obj[name] = Object.assign({}, obj[name] || {}, data);
  setStudentProfiles(obj);
}
function getRankProfiles() {
  try { return JSON.parse(localStorage.getItem('dojo_rank_profiles') || '{}'); }
  catch (e) { return {}; }
}
function setRankProfiles(obj) {
  try { localStorage.setItem('dojo_rank_profiles', JSON.stringify(obj)); }
  catch (e) {}
}
function getRankProfile(name) { return getRankProfiles()[name] || {}; }
function setRankProfile(name, data) {
  var obj = getRankProfiles();
  obj[name] = Object.assign({}, obj[name] || {}, data);
  setRankProfiles(obj);
}

// Grade rank system (USJF official)
var BELT_STYLES = {
  'white':       { bg:'#f5f5f5',   text:'#555',    border:'#ccc' },
  'whiteyellow': { bg:'linear-gradient(90deg,#f5f5f5 38%,#fef08a 38%,#fef08a 62%,#f5f5f5 62%)', text:'#713f12', border:'#ca8a04' },
  'yellow':      { bg:'#fef08a',   text:'#713f12', border:'#ca8a04' },
  'yelloworange':{ bg:'linear-gradient(90deg,#fef08a 38%,#fed7aa 38%,#fed7aa 62%,#fef08a 62%)', text:'#7c2d12', border:'#ea580c' },
  'orange':      { bg:'#fed7aa',   text:'#7c2d12', border:'#ea580c' },
  'orangegreen': { bg:'linear-gradient(90deg,#fed7aa 38%,#bbf7d0 38%,#bbf7d0 62%,#fed7aa 62%)', text:'#14532d', border:'#16a34a' },
  'green':       { bg:'#bbf7d0',   text:'#14532d', border:'#16a34a' },
  'greenblue':   { bg:'linear-gradient(90deg,#bbf7d0 38%,#bfdbfe 38%,#bfdbfe 62%,#bbf7d0 62%)', text:'#1e3a5f', border:'#2563eb' },
  'blue':        { bg:'#bfdbfe',   text:'#1e3a5f', border:'#2563eb' },
  'bluepurple':  { bg:'linear-gradient(90deg,#bfdbfe 38%,#e9d5ff 38%,#e9d5ff 62%,#bfdbfe 62%)', text:'#581c87', border:'#7c3aed' },
  'purple':      { bg:'#e9d5ff',   text:'#581c87', border:'#7c3aed' },
  'brown':       { bg:'#d6b8a0',   text:'#3b1a0a', border:'#92400e' },
  'black':       { bg:'#111111',   text:'#fff',    border:'#000' },
  'redwhite':    { bg:'linear-gradient(90deg,#ef4444 38%,#f5f5f5 38%,#f5f5f5 62%,#ef4444 62%)', text:'#7f1d1d', border:'#dc2626' },
  'red':         { bg:'#ef4444',   text:'#fff',    border:'#dc2626' }
};

// Junior belt system (16 & under) — 13 grades
var JUNIOR_GRADES = [
  { key:'juichikyu', label:'11th Kyu · Juichi-kyu', short:'11th Kyu', belt:'white' },
  { key:'jukyu',     label:'10th Kyu · Ju-kyu',     short:'10th Kyu', belt:'whiteyellow' },
  { key:'kyukyu',    label:'9th Kyu · Kyu-kyu',      short:'9th Kyu',  belt:'yellow' },
  { key:'hachikyu',  label:'8th Kyu · Hachi-kyu',    short:'8th Kyu',  belt:'yelloworange' },
  { key:'nanakyu',   label:'7th Kyu · Nana-kyu',     short:'7th Kyu',  belt:'orange' },
  { key:'rokkyu',    label:'6th Kyu · Rok-kyu',      short:'6th Kyu',  belt:'orangegreen' },
  { key:'gokyu',     label:'5th Kyu · Go-kyu',       short:'5th Kyu',  belt:'green' },
  { key:'yonkyu',    label:'4th Kyu · Yon-kyu',      short:'4th Kyu',  belt:'greenblue' },
  { key:'sankyu',    label:'3rd Kyu · San-kyu',       short:'3rd Kyu',  belt:'blue' },
  { key:'nikyu',     label:'2nd Kyu · Ni-kyu',        short:'2nd Kyu',  belt:'bluepurple' },
  { key:'ikkyu',     label:'1st Kyu · Ik-kyu',        short:'1st Kyu',  belt:'purple' },
  { key:'shodan',    label:'1st Dan · Shodan',         short:'Shodan',   belt:'black' },
  { key:'nidan',     label:'2nd Dan · Nidan',          short:'Nidan',    belt:'black' }
];

// Senior belt system (17+) — 16 grades
var SENIOR_GRADES = [
  { key:'rokkyu',    label:'6th Kyu · Rok-kyu',       short:'6th Kyu',    belt:'white' },
  { key:'gokyu',     label:'5th Kyu · Go-kyu',         short:'5th Kyu',    belt:'green' },
  { key:'yonkyu',    label:'4th Kyu · Yon-kyu',        short:'4th Kyu',    belt:'blue' },
  { key:'sankyu',    label:'3rd Kyu · San-kyu',         short:'3rd Kyu',    belt:'brown' },
  { key:'nikyu',     label:'2nd Kyu · Ni-kyu',          short:'2nd Kyu',    belt:'brown' },
  { key:'ikkyu',     label:'1st Kyu · Ik-kyu',          short:'1st Kyu',    belt:'brown' },
  { key:'shodan',    label:'1st Dan · Shodan',           short:'Shodan',     belt:'black' },
  { key:'nidan',     label:'2nd Dan · Nidan',            short:'Nidan',      belt:'black' },
  { key:'sandan',    label:'3rd Dan · Sandan',           short:'Sandan',     belt:'black' },
  { key:'yondan',    label:'4th Dan · Yondan',           short:'Yondan',     belt:'black' },
  { key:'godan',     label:'5th Dan · Godan',            short:'Godan',      belt:'black' },
  { key:'rokudan',   label:'6th Dan · Rokudan',          short:'Rokudan',    belt:'redwhite' },
  { key:'shichidan', label:'7th Dan · Shichidan',        short:'Shichidan',  belt:'redwhite' },
  { key:'hachidan',  label:'8th Dan · Hachidan',         short:'Hachidan',   belt:'redwhite' },
  { key:'kudan',     label:'9th Dan · Kudan',            short:'Kudan',      belt:'red' },
  { key:'judan',     label:'10th Dan · Judan',           short:'Judan',      belt:'red' }
];


// Belt sort rank (higher = more senior)
var BELT_SORT_RANK = {
  'red':15,'redwhite':14,'black':13,'purple':12,'brown':11,
  'bluepurple':10,'blue':9,'greenblue':8,'green':7,'orangegreen':6,
  'orange':5,'yelloworange':4,'yellow':3,'whiteyellow':2,'white':1
};

function getGradeList(division) {
  return division === 'junior' ? JUNIOR_GRADES : SENIOR_GRADES;
}
function getBeltForGrade(grade, division) {
  var list = getGradeList(division);
  for (var i = 0; i < list.length; i++) { if (list[i].key === grade) return list[i].belt; }
  return '';
}
function getGradeShort(grade, division) {
  var list = getGradeList(division);
  for (var i = 0; i < list.length; i++) { if (list[i].key === grade) return list[i].short; }
  return '—';
}
function gradeBadge(grade, division, large) {
  var belt = getBeltForGrade(grade, division);
  var label = getGradeShort(grade, division);
  var size = large ? 'font-size:14px;padding:6px 14px;' : '';
  if (!grade || !belt) return '<span class="rk-belt-badge" style="background:#f5f5f5;color:#aaa;border-color:#e0e0e0;' + size + '">—</span>';
  var s = BELT_STYLES[belt] || BELT_STYLES['white'];
  return '<span class="rk-belt-badge" style="background:' + s.bg + ';color:' + s.text + ';border-color:' + s.border + ';' + size + '">' + label + '</span>';
}
function gradeSortKey(name) {
  var p = getRankProfile(name);
  var division = p.division || '';
  var grade = p.grade || '';
  var grades = division === 'junior' ? JUNIOR_GRADES : SENIOR_GRADES;
  var gradeIdx = -1;
  var belt = '';
  for (var i = 0; i < grades.length; i++) {
    if (grades[i].key === grade) { gradeIdx = i; belt = grades[i].belt; break; }
  }
  var beltRank = BELT_SORT_RANK[belt] || 0;
  return [beltRank, gradeIdx, p.promotionDate || '9999-99'];
}

function fmtDateShort(iso) {
  // "2026-02-15" → "Feb 15, 2026"
  if (!iso) return '';
  var parts = iso.split('-');
  if (parts.length < 3) return iso;
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var mo = months[parseInt(parts[1], 10) - 1] || parts[1];
  return mo + ' ' + parseInt(parts[2], 10) + ', ' + parts[0];
}

function fmtDate(d) {
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, '0');
  var day = String(d.getDate()).padStart(2, '0');
  return y + '-' + m + '-' + day;
}

function todayStr() { return fmtDate(new Date()); }

function isDayCancelled(key) { return getCancelled().includes(key); }

var toastTimer = null;

function showToast(msg, state) {
  if (state === undefined) state = 'saved';
  var t = document.getElementById('toast');
  clearTimeout(toastTimer);

  var icon = '';
  var cls = 'toast show';

  if (state === 'saved') {
    icon = '<span class="toast-icon">&#10003;</span>';
    cls += ' toast-saved';
  } else if (state === 'pending') {
    icon = '<div class="toast-spinner"></div>';
    cls += ' toast-pending';
  } else if (state === 'error') {
    icon = '<span class="toast-icon">!</span>';
    cls += ' toast-error';
  }

  t.className = cls;
  t.innerHTML = icon + '<span>' + msg + '</span>';

  if (state === 'pending') return; // stays until replaced

  toastTimer = setTimeout(function() {
    t.className = 'toast';
  }, state === 'error' ? 4000 : 2000);
}

// ═══════════════════════════════════
// SYNC QUEUE SYSTEM
// ═══════════════════════════════════
var syncDebounce = null;
var lastSavedTime = null;
var SYNC_QUEUE_KEY = 'dojo_sync_queue';

function getSyncQueue() {
  try { return JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]'); }
  catch (e) { return []; }
}

function setSyncQueue(q) {
  try { localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(q)); }
  catch (e) {}
}

function queueChange(change) {
  var q = getSyncQueue();
  if (change.action === 'saveAttendance') {
    var idx = q.findIndex(function(c) { return c.action === 'saveAttendance' && c.date === change.date; });
    if (idx >= 0) q[idx] = change;
    else q.push(change);
  } else {
    q.push(change);
  }
  setSyncQueue(q);
}

async function flushSyncQueue() {
  if (!navigator.onLine) return false;
  var q = getSyncQueue();
  if (!q.length) return true;
  var remaining = [];
  for (var i = 0; i < q.length; i++) {
    try {
      var payload = Object.assign({}, q[i], { key: WRITE_KEY });
      var ctrl = new AbortController();
      var timer = setTimeout(function() { ctrl.abort(); }, 12000);
      var res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload),
        signal: ctrl.signal
      });
      clearTimeout(timer);
      if (!res.ok) { remaining.push(q[i]); continue; }
      var data = await res.json().catch(function() { return {}; });
      if (data.error) remaining.push(q[i]);
    } catch (e) {
      remaining.push(q[i]);
    }
  }
  setSyncQueue(remaining);
  return remaining.length === 0;
}

function setSyncState(state, msg) {
  var bar = document.getElementById('siSync');
  var dot = document.getElementById('siSyncDot');
  var text = document.getElementById('siSyncText');

  bar.className = 'si-sync' + (state === 'saving' ? ' saving' : '') + (state === 'retrying' ? ' retrying' : '') + (state === 'error' ? ' error' : '');
  dot.className = 'si-sync-dot ' + ({saved:'green', saving:'green', retrying:'yellow', error:'red'}[state] || 'green');
  text.textContent = msg;
}

function formatSavedTime(date) {
  return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }).toLowerCase();
}

function triggerSync() {
  clearTimeout(syncDebounce);
  setSyncState('saving', 'Saving\u2026');
  syncDebounce = setTimeout(async function() {
    try {
      var success = await flushSyncQueue();
      if (success) {
        lastSavedTime = new Date();
        setSyncState('saved', 'Saved ' + formatSavedTime(lastSavedTime));
      } else {
        setSyncState('error', 'Save failed');
      }
    } catch (e) {
      setSyncState('error', 'Save failed');
    }
  }, 800);
}

function siRetrySync() {
  setSyncState('retrying', 'Retrying\u2026');
  flushSyncQueue().then(function(success) {
    if (success) {
      lastSavedTime = new Date();
      setSyncState('saved', 'Saved ' + formatSavedTime(lastSavedTime));
    } else {
      setSyncState('error', 'Save failed');
    }
  }).catch(function() {
    setSyncState('error', 'Save failed');
  });
}

// ═══════════════════════════════════
// SERVER DATA LOADING
// ═══════════════════════════════════
function timedFetch(url, ms) {
  var ctrl = new AbortController();
  var t = setTimeout(function() { ctrl.abort(); }, ms);
  return fetch(url, { signal: ctrl.signal }).finally(function() { clearTimeout(t); });
}

async function loadFromServer() {
  if (!navigator.onLine) return;
  try {
    var results = await Promise.all([
      timedFetch(APPS_SCRIPT_URL + '?action=roster', 15000).catch(function() { return null; }),
      timedFetch(APPS_SCRIPT_URL + '?action=allAttendance', 15000).catch(function() { return null; }),
      timedFetch(APPS_SCRIPT_URL + '?action=cancelled', 15000).catch(function() { return null; }),
      timedFetch(APPS_SCRIPT_URL + '?action=dues', 15000).catch(function() { return null; }),
      timedFetch(APPS_SCRIPT_URL + '?action=settings', 15000).catch(function() { return null; })
    ]);

    if (results[0] && results[0].ok) {
      var rData = await results[0].json();
      if (rData.roster && rData.roster.length) setRoster(rData.roster);
    }

    if (results[1] && results[1].ok) {
      var aData = await results[1].json();
      if (aData.attendance) {
        var localAtt = getAtt();
        var localRemoved = getRemoved();
        var queue = getSyncQueue();
        var dirtyDates = {};
        queue.forEach(function(c) { if (c.action === 'saveAttendance') dirtyDates[c.date] = true; });
        var merged = Object.assign({}, aData.attendance);
        var mergedRemoved = Object.assign({}, aData.removed || {});
        Object.keys(dirtyDates).forEach(function(date) {
          if (localAtt[date] !== undefined) merged[date] = localAtt[date];
          if (localRemoved[date] !== undefined) mergedRemoved[date] = localRemoved[date];
        });
        setAtt(merged);
        setRemoved(mergedRemoved);
      }
    }

    if (results[2] && results[2].ok) {
      var cData = await results[2].json();
      if (cData.cancelled) {
        var queue2 = getSyncQueue();
        var pendingCancels = {};
        var pendingRestores = {};
        queue2.forEach(function(c) {
          if (c.action === 'cancelClass') pendingCancels[c.date] = true;
          if (c.action === 'restoreClass') pendingRestores[c.date] = true;
        });
        var cancelled = cData.cancelled.slice();
        Object.keys(pendingCancels).forEach(function(d) { if (cancelled.indexOf(d) === -1) cancelled.push(d); });
        Object.keys(pendingRestores).forEach(function(d) { cancelled = cancelled.filter(function(x) { return x !== d; }); });
        setCancelled(cancelled);
      }
    }

    // Dues data
    if (results[3] && results[3].ok) {
      var dData = await results[3].json();
      if (dData.dues) {
        var localDues = getDues();
        var queue3 = getSyncQueue();
        var dirtyDuesKeys = {};
        queue3.forEach(function(c) { if (c.action === 'toggleDues') dirtyDuesKeys[c.month + '|' + c.name] = true; });
        // Merge server data, keeping local overrides for queued changes
        Object.keys(dData.dues).forEach(function(month) {
          if (!localDues[month]) localDues[month] = {};
          Object.keys(dData.dues[month]).forEach(function(name) {
            if (!dirtyDuesKeys[month + '|' + name]) {
              localDues[month][name] = dData.dues[month][name];
            }
          });
        });
        setDues(localDues);
      }
    }

    // Settings
    if (results[4] && results[4].ok) {
      var sData = await results[4].json();
      if (sData.settings && sData.settings.duesEnabled !== undefined) {
        localStorage.setItem('deleon_dues_enabled', sData.settings.duesEnabled);
      }
    }

    if (activeTab === 'signin') siRender();
    if (activeTab === 'roster') roRender();
    if (activeTab === 'rank') rkRender();
    if (activeTab === 'stats') stRender();
    if (activeTab === 'dues') duesRender();
    lastSavedTime = new Date();
    setSyncState('saved', 'Synced ' + formatSavedTime(lastSavedTime));
  } catch (err) {
    console.warn('Could not load data from server:', err);
  }
}

// ═══════════════════════════════════
// PIN GATE
// ═══════════════════════════════════
const ADMIN_PIN = '1970';
const SESSION_MINUTES = 60;
var pinEntry = '';

function isUnlocked() {
  var ts = localStorage.getItem('dojo_pin_ts');
  if (!ts) return false;
  return (Date.now() - parseInt(ts)) < SESSION_MINUTES * 60 * 1000;
}

function unlock() {
  localStorage.setItem('dojo_pin_ts', String(Date.now()));
  document.getElementById('pinScreen').classList.add('hidden');
}

function showPin() {
  pinEntry = '';
  pinUpdateDots();
  document.getElementById('pinError').textContent = '';
  document.getElementById('pinScreen').classList.remove('hidden');
}

function pinPress(digit) {
  if (pinEntry.length >= 4) return;
  pinEntry += digit;
  pinUpdateDots();
  if (pinEntry.length === 4) {
    setTimeout(pinSubmit, 200);
  }
}

function pinBack() {
  if (pinEntry.length === 0) return;
  pinEntry = pinEntry.slice(0, -1);
  pinUpdateDots();
  document.getElementById('pinError').textContent = '';
}

document.addEventListener('keydown', function(e) {
  if (document.getElementById('pinScreen').classList.contains('hidden')) return;
  if (e.key >= '0' && e.key <= '9') pinPress(e.key);
  else if (e.key === 'Backspace') pinBack();
});

function pinUpdateDots() {
  for (var i = 0; i < 4; i++) {
    var dot = document.getElementById('dot' + i);
    dot.className = 'pin-dot' + (i < pinEntry.length ? ' filled' : '');
  }
}

function pinSubmit() {
  if (pinEntry === ADMIN_PIN) {
    unlock();
    // Continue to whichever tab triggered the PIN
    if (activeTab === 'signin') siRender();
    if (activeTab === 'roster') roRender();
  } else {
    // Shake dots red
    for (var i = 0; i < 4; i++) {
      document.getElementById('dot' + i).className = 'pin-dot error';
    }
    document.getElementById('pinError').textContent = 'Wrong PIN';
    setTimeout(function() {
      pinEntry = '';
      pinUpdateDots();
    }, 600);
  }
}

function requirePin(tabName) {
  // Stats is always open
  if (tabName === 'stats') return false;
  return !isUnlocked();
}

// ═══════════════════════════════════
// TAB NAVIGATION
// ═══════════════════════════════════
var activeTab = 'signin';

function switchTab(name) {
  activeTab = name;
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.getElementById('page-' + name).classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name !== 'signin') document.body.classList.remove('past-mode');

  if (requirePin(name)) {
    showPin();
    return;
  }

  if (name === 'signin') siRender();
  if (name === 'roster') roRender();
  if (name === 'rank') rkRender();
  if (name === 'stats') stRender();
  if (name === 'dues') duesRender();
  window.scrollTo(0, 0);
}

// ═══════════════════════════════════
// SIGN IN PAGE
// ═══════════════════════════════════
function buildClassDays() {
  var days = [];
  var today = new Date(todayStr() + 'T12:00:00');
  var d = new Date(today);
  d.setDate(d.getDate() - 90);
  // Past + today
  while (d <= today) {
    if (CLASS_DAYS.includes(d.getDay())) days.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }
  // Future: 3 weeks out
  var future = new Date(today);
  future.setDate(future.getDate() + 21);
  var next = new Date(today); next.setDate(next.getDate() + 1);
  while (next <= future) {
    if (CLASS_DAYS.includes(next.getDay())) days.push(new Date(next));
    next.setDate(next.getDate() + 1);
  }
  return days;
}

var siDays = buildClassDays();
var siIdx; // set in init

function siInit() {
  // Find today or most recent class day
  var ts = todayStr();
  var best = siDays.length - 1;
  for (var i = siDays.length - 1; i >= 0; i--) {
    if (fmtDate(siDays[i]) <= ts) { best = i; break; }
  }
  siIdx = best;
}

function siRender() {
  var dt = siDays[siIdx];
  var key = fmtDate(dt);
  var ts = todayStr();
  var isPast = key < ts;
  var isFuture = key > ts;
  var isToday = key === ts;
  var cancelled = isDayCancelled(key);

  var page = document.getElementById('page-signin');
  var cls = 'page active';
  if (isPast) cls += ' si-past';
  if (isFuture) cls += ' si-future';
  if (cancelled) cls += ' si-cancelled';
  page.className = cls;
  document.body.classList.toggle('past-mode', isPast);

  var m = dt.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
  var currentYear = new Date(todayStr() + 'T12:00:00').getFullYear();
  var dateYear = dt.getFullYear();
  var yearSuffix = dateYear !== currentYear ? " '" + String(dateYear).slice(2) : '';
  document.getElementById('siDate').textContent = m + ' ' + dt.getDate() + yearSuffix;
  document.getElementById('siWeekday').textContent = dt.toLocaleDateString('en-US', { weekday: 'long' });

  // Tag
  var tag = '';
  if (cancelled) tag = '<span class="si-date-tag" style="background:#fca5a5;color:#7f1d1d;">Cancelled</span>';
  else if (isToday) tag = '<span class="si-date-tag" style="background:#dcfce7;color:#166534;">Today</span>';
  else if (isFuture) tag = '<span class="si-date-tag" style="background:#e0e7ff;color:#4338ca;">Upcoming</span>';
  else if (isPast) tag = '<span class="si-date-tag" style="background:#fbbf24;color:#451a03;">Completed</span>';
  document.getElementById('siTag').innerHTML = tag;

  document.getElementById('siPrev').disabled = siIdx <= 0;
  document.getElementById('siNext').disabled = siIdx >= siDays.length - 1;

  var roster = getRoster();
  var att = getAtt();
  var present = att[key] || [];
  var ps = new Set(present);
  var count = ps.size;

  document.getElementById('siCount').innerHTML =
    '<span class="num">' + count + '</span> of ' + roster.length + ' present';

  document.getElementById('siToggleAll').textContent = count > 0 ? 'Clear all' : 'Mark all';

  // Cancel button state
  var cancelBtn = document.getElementById('siCancelBtn');
  cancelBtn.textContent = cancelled ? 'Restore class' : 'Cancel class';
  cancelBtn.classList.toggle('btn-cancel-active', cancelled);

  document.getElementById('siRoster').innerHTML = roster.map(function(name, i) {
    var on = ps.has(name);
    return '<div class="si-row' + (on ? ' present' : '') + '" onclick="siToggle(\'' + name.replace(/'/g, "\\'") + '\')">' +
      '<span class="si-num">' + (i + 1) + '</span>' +
      '<span class="si-name">' + name + '</span>' +
      '<div class="si-toggle"></div>' +
    '</div>';
  }).join('');
}

function siToggleCancel() {
  var key = fmtDate(siDays[siIdx]);
  var cancelled = getCancelled();
  var isCancelled = cancelled.includes(key);
  var dt = siDays[siIdx];
  var dateLabel = dt.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

  if (isCancelled) {
    // Restore — confirm
    document.getElementById('modalBody').innerHTML =
      'Restore class on <strong>' + dateLabel + '</strong>? It will count toward attendance stats again.';
    document.getElementById('modalTitle').textContent = 'Restore class?';
    document.getElementById('modalConfirm').textContent = 'Restore';
    document.getElementById('modalConfirm').className = 'modal-btn btn-green';
    document.getElementById('modalConfirm').onclick = function() {
      var c = getCancelled();
      c.splice(c.indexOf(key), 1);
      setCancelled(c);
      queueChange({ action: 'restoreClass', date: key });
      modalClose();
      siRender();
      triggerSync();
    };
  } else {
    // Cancel — confirm
    document.getElementById('modalBody').innerHTML =
      'Cancel class on <strong>' + dateLabel + '</strong>? This day will be excluded from attendance stats.';
    document.getElementById('modalTitle').textContent = 'Cancel class?';
    document.getElementById('modalConfirm').textContent = 'Cancel class';
    document.getElementById('modalConfirm').className = 'modal-btn modal-danger';
    document.getElementById('modalConfirm').onclick = function() {
      var c = getCancelled();
      c.push(key);
      setCancelled(c);
      queueChange({ action: 'cancelClass', date: key });
      modalClose();
      siRender();
      triggerSync();
    };
  }
  document.getElementById('modalOverlay').classList.add('show');
}

function siToggle(name) {
  var key = fmtDate(siDays[siIdx]);
  var att = getAtt();
  var removedAll = getRemoved();
  var p = att[key] || [];
  var r = removedAll[key] || [];
  var idx = p.indexOf(name);
  if (idx >= 0) {
    // Toggling off: remove from present, add to removed
    p.splice(idx, 1);
    if (r.indexOf(name) === -1) r.push(name);
  } else {
    // Toggling on: add to present, remove from removed
    p.push(name);
    var rIdx = r.indexOf(name);
    if (rIdx >= 0) r.splice(rIdx, 1);
  }
  att[key] = p; setAtt(att);
  removedAll[key] = r; setRemoved(removedAll);
  siRender();
  queueChange({ action: 'saveAttendance', date: key, names: p, removed: r });
  triggerSync();
}

function siToggleAll() {
  var key = fmtDate(siDays[siIdx]);
  var ts = todayStr();
  var isPast = key < ts;
  var att = getAtt();
  var removedAll = getRemoved();
  var p = att[key] || [];
  var r = removedAll[key] || [];
  var roster = getRoster();

  if (p.length > 0) {
    if (isPast) {
      var dt = siDays[siIdx];
      var dateLabel = dt.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
      document.getElementById('modalTitle').textContent = 'Clear all attendance?';
      document.getElementById('modalBody').innerHTML =
        'This will remove all ' + p.length + ' check-ins for <strong>' + dateLabel + '</strong>. This class has already been completed.';
      document.getElementById('modalConfirm').textContent = 'Clear all';
      document.getElementById('modalConfirm').className = 'modal-btn modal-danger';
      document.getElementById('modalConfirm').onclick = function() {
        p.forEach(function(name) { if (r.indexOf(name) === -1) r.push(name); });
        att[key] = []; setAtt(att);
        removedAll[key] = r; setRemoved(removedAll);
        modalClose(); siRender();
        queueChange({ action: 'saveAttendance', date: key, names: [], removed: r });
        triggerSync();
      };
      document.getElementById('modalOverlay').classList.add('show');
    } else {
      p.forEach(function(name) { if (r.indexOf(name) === -1) r.push(name); });
      att[key] = []; setAtt(att);
      removedAll[key] = r; setRemoved(removedAll);
      siRender();
      queueChange({ action: 'saveAttendance', date: key, names: [], removed: r });
      triggerSync();
    }
  } else {
    // Select all: clear removed list entirely for this date
    att[key] = roster.slice(); setAtt(att);
    removedAll[key] = []; setRemoved(removedAll);
    siRender();
    queueChange({ action: 'saveAttendance', date: key, names: roster.slice(), removed: [] });
    triggerSync();
  }
}

function siNav(dir) {
  var n = siIdx + dir;
  if (n >= 0 && n < siDays.length) { siIdx = n; siRender(); }
}

// ═══════════════════════════════════
// ROSTER PAGE
// ═══════════════════════════════════
function roStatusBadge(name) {
  var status = (getStudentProfile(name).status) || 'active';
  var labels = { active: 'Active', inactive: 'Inactive', teacher: 'Teacher' };
  return '<button class="ro-status ro-status-' + status + '" onclick="event.stopPropagation();roOpenStatus(\'' + name.replace(/'/g, "\\'") + '\')">' + (labels[status] || 'Active') + '</button>';
}

function roRender() {
  var activeRoster = getRoster();
  var profiles = getStudentProfiles();
  // Build full list: active roster + hidden students (inactive/teacher)
  var allNames = activeRoster.slice();
  Object.keys(profiles).forEach(function(name) {
    var status = profiles[name].status;
    if ((status === 'inactive' || status === 'teacher') && !allNames.includes(name)) {
      allNames.push(name);
    }
  });
  allNames.sort(function(a, b) { return a.localeCompare(b); });

  var activeCount = activeRoster.length;
  var totalCount = allNames.length;
  document.getElementById('roSubtitle').textContent = activeCount + ' active' + (totalCount > activeCount ? ', ' + (totalCount - activeCount) + ' hidden' : '');

  document.getElementById('roList').innerHTML = allNames.map(function(name, i) {
    var escaped = name.replace(/'/g, "\\'");
    var status = (profiles[name] && profiles[name].status) || 'active';
    var dimStyle = status !== 'active' ? ' style="opacity:0.55"' : '';
    return '<div class="ro-row"' + dimStyle + '>' +
      '<span class="ro-num">' + (i + 1) + '</span>' +
      '<span class="ro-name">' + name + '</span>' +
      roStatusBadge(name) +
      '<button class="ro-edit" onclick="roEdit(\'' + escaped + '\')">&#9998;</button>' +
      '<button class="ro-delete" onclick="roDelete(\'' + escaped + '\')">&#10005;</button>' +
    '</div>';
  }).join('');
}

var editingStudent = null;

function roShowAdd() {
  editingStudent = null;
  document.getElementById('roFirstName').value = '';
  document.getElementById('roLastName').value = '';
  document.getElementById('roFirstName').classList.remove('error');
  document.getElementById('roLastName').classList.remove('error');
  document.getElementById('roAddTitle').textContent = 'Add Student';
  document.getElementById('roAddBtn').textContent = 'Add';
  document.getElementById('roAddBody').style.display = '';
  document.getElementById('roAddActions').style.display = '';
  document.getElementById('roAddSuccess').style.display = 'none';
  document.getElementById('roAddOverlay').classList.add('show');
  setTimeout(function() { document.getElementById('roFirstName').focus(); }, 200);
}

function roEdit(name) {
  editingStudent = name;
  var parts = name.split(', ');
  document.getElementById('roFirstName').value = parts[1] || '';
  document.getElementById('roLastName').value = parts[0] || '';
  document.getElementById('roFirstName').classList.remove('error');
  document.getElementById('roLastName').classList.remove('error');
  document.getElementById('roAddTitle').textContent = 'Edit Student';
  document.getElementById('roAddBtn').textContent = 'Save';
  document.getElementById('roAddBody').style.display = '';
  document.getElementById('roAddActions').style.display = '';
  document.getElementById('roAddSuccess').style.display = 'none';
  document.getElementById('roAddOverlay').classList.add('show');
  setTimeout(function() { document.getElementById('roFirstName').focus(); }, 200);
}

function roEditConfirm() {
  var last = document.getElementById('roLastName').value.trim();
  var first = document.getElementById('roFirstName').value.trim();

  var valid = true;
  document.getElementById('roLastName').classList.remove('error');
  document.getElementById('roFirstName').classList.remove('error');
  if (!last) { document.getElementById('roLastName').classList.add('error'); valid = false; }
  if (!first) { document.getElementById('roFirstName').classList.add('error'); valid = false; }
  if (!valid) return;

  var newName = last + ', ' + first;
  var oldName = editingStudent;

  // No change
  if (newName === oldName) { roCloseAdd(); return; }

  var roster = getRoster();
  if (roster.includes(newName)) {
    showToast('Already on roster', 'error');
    return;
  }

  // Update roster
  roster = roster.filter(function(n) { return n !== oldName; });
  roster.push(newName);
  roster.sort(function(a, b) { return a.localeCompare(b); });
  setRoster(roster);

  // Update all attendance records
  var att = getAtt();
  Object.keys(att).forEach(function(date) {
    att[date] = att[date].map(function(n) { return n === oldName ? newName : n; });
  });
  setAtt(att);

  // Migrate profile keys to new name
  var sp = getStudentProfiles();
  if (sp[oldName]) { sp[newName] = sp[oldName]; delete sp[oldName]; setStudentProfiles(sp); }
  var rp = getRankProfiles();
  if (rp[oldName]) { rp[newName] = rp[oldName]; delete rp[oldName]; setRankProfiles(rp); }

  queueChange({ action: 'editStudent', oldName: oldName, newLast: last, newFirst: first });

  // Show success state
  document.getElementById('roAddBody').style.display = 'none';
  document.getElementById('roAddActions').style.display = 'none';
  document.getElementById('roAddSuccess').style.display = '';
  document.getElementById('roAddTitle').textContent = '';
  document.getElementById('roAddSuccessName').textContent = newName;
  document.getElementById('roAddSuccessMsg').textContent = 'Updated';

  setTimeout(function() {
    roCloseAdd();
    roRender();
    document.getElementById('roAddSuccessMsg').textContent = 'Added to roster';
  }, 1200);

  triggerSync();
}

function roCloseAdd() {
  document.getElementById('roAddOverlay').classList.remove('show');
}

function roAddConfirm() {
  var last = document.getElementById('roLastName').value.trim();
  var first = document.getElementById('roFirstName').value.trim();

  var valid = true;
  document.getElementById('roLastName').classList.remove('error');
  document.getElementById('roFirstName').classList.remove('error');

  if (!last) { document.getElementById('roLastName').classList.add('error'); valid = false; }
  if (!first) { document.getElementById('roFirstName').classList.add('error'); valid = false; }
  if (!valid) return;

  var fullName = last + ', ' + first;
  var roster = getRoster();

  if (roster.includes(fullName)) {
    showToast('Already on roster', 'error');
    return;
  }

  roster.push(fullName);
  roster.sort(function(a, b) { return a.localeCompare(b); });
  setRoster(roster);
  queueChange({ action: 'addStudent', last: last, first: first });

  // Show success state
  document.getElementById('roAddBody').style.display = 'none';
  document.getElementById('roAddActions').style.display = 'none';
  document.getElementById('roAddSuccess').style.display = '';
  document.getElementById('roAddTitle').textContent = '';
  document.getElementById('roAddSuccessName').textContent = fullName;

  setTimeout(function() {
    roCloseAdd();
    roRender();
  }, 1200);
}

var pendingDelete = null;

function roDelete(name) {
  pendingDelete = name;
  document.getElementById('modalTitle').textContent = 'Remove student?';
  document.getElementById('modalBody').innerHTML =
    '<strong>' + name + '</strong> will be removed from the roster. Their attendance history will be kept.';
  document.getElementById('modalConfirm').textContent = 'Remove';
  document.getElementById('modalConfirm').className = 'modal-btn modal-danger';
  document.getElementById('modalConfirm').onclick = roConfirmDelete;
  document.getElementById('modalOverlay').classList.add('show');
}

function modalClose() {
  document.getElementById('modalOverlay').classList.remove('show');
  pendingDelete = null;
}

function roConfirmDelete() {
  if (!pendingDelete) return;
  var name = pendingDelete;
  var roster = getRoster().filter(function(n) { return n !== name; });
  setRoster(roster);
  var att = getAtt();
  var ts = todayStr();
  Object.keys(att).forEach(function(k) {
    if (k > ts) att[k] = att[k].filter(function(n) { return n !== name; });
  });
  setAtt(att);
  queueChange({ action: 'removeStudent', name: name });
  // Clean up profile data for deleted student
  var sp = getStudentProfiles(); delete sp[name]; setStudentProfiles(sp);
  modalClose();
  roRender();
  showToast('Removed ' + name);
}

// ═══════════════════════════════════
// ROSTER STATUS SHEET
// ═══════════════════════════════════
var statusEditingName = null;
var statusSelectedValue = 'active';

function roOpenStatus(name) {
  statusEditingName = name;
  statusSelectedValue = (getStudentProfile(name).status) || 'active';
  document.getElementById('roStatusName').textContent = name;
  roStatusUpdateUI();
  document.getElementById('roStatusOverlay').classList.add('show');
}

function roStatusUpdateUI() {
  ['active','inactive','teacher'].forEach(function(s) {
    var el = document.getElementById('roStatusOpt' + s.charAt(0).toUpperCase() + s.slice(1));
    el.classList.toggle('selected', s === statusSelectedValue);
  });
}

function roStatusSelect(val) {
  statusSelectedValue = val;
  roStatusUpdateUI();
}

function roStatusClose() {
  document.getElementById('roStatusOverlay').classList.remove('show');
  statusEditingName = null;
}

function roStatusSave() {
  if (!statusEditingName) return;
  var name = statusEditingName;
  var oldProfile = getStudentProfile(name);
  var oldStatus = oldProfile.status || 'active';
  var newStatus = statusSelectedValue;

  setStudentProfile(name, { status: newStatus });

  var roster = getRoster();
  var onRoster = roster.includes(name);

  if (newStatus === 'active' && !onRoster) {
    // Re-add to sign-in roster
    roster.push(name);
    roster.sort(function(a, b) { return a.localeCompare(b); });
    setRoster(roster);
    var parts = name.split(', ');
    queueChange({ action: 'addStudent', last: parts[0] || name, first: parts[1] || '' });
  } else if (newStatus !== 'active' && onRoster) {
    // Remove from sign-in roster
    setRoster(roster.filter(function(n) { return n !== name; }));
    queueChange({ action: 'removeStudent', name: name });
  }

  roStatusClose();
  roRender();
  triggerSync();
}

// ═══════════════════════════════════
// RANK PAGE
// ═══════════════════════════════════
var rkProfileCurrentName = null;
function rkAllNames() {
  // All roster students (active + inactive + teacher)
  var roster = getRoster();
  var profiles = getStudentProfiles();
  var names = roster.slice();
  Object.keys(profiles).forEach(function(n) {
    var s = profiles[n].status;
    if ((s === 'inactive' || s === 'teacher') && !names.includes(n)) names.push(n);
  });
  return names;
}

function rkSortNames(names) {
  return names.slice().sort(function(a, b) {
    var ka = gradeSortKey(a), kb = gradeSortKey(b);
    if (kb[0] !== ka[0]) return kb[0] - ka[0];
    if (kb[1] !== ka[1]) return kb[1] - ka[1];
    return ka[2].localeCompare(kb[2]);
  });
}

function rkRender() {
  var names = rkSortNames(rkAllNames());
  document.getElementById('rkSubtitle').textContent = names.length + ' members';
  document.getElementById('rkList').innerHTML = names.map(function(name) {
    var escaped = name.replace(/'/g, "\\'");
    var rp = getRankProfile(name);
    var badge = gradeBadge(rp.grade, rp.division);
    var gradeLabel = rp.grade ? getGradeShort(rp.grade, rp.division) : '—';
    var dateStr = rp.promotionDate ? fmtDateShort(rp.promotionDate) : '';
    return '<div class="rk-row" onclick="rkOpenProfile(\'' + escaped + '\')">' +
      badge +
      '<div class="rk-row-name">' + name + '</div>' +
      '<div class="rk-row-right">' +
        '<div class="rk-row-grade">' + gradeLabel + '</div>' +
        (dateStr ? '<div class="rk-row-date">' + dateStr + '</div>' : '') +
      '</div>' +
    '</div>';
  }).join('') || '<div style="padding:40px;text-align:center;color:var(--text-light);font-weight:600">No members yet</div>';
}

function rkOpenProfile(name) {
  rkProfileCurrentName = name;
  var rp = getRankProfile(name);
  document.getElementById('rkProfileName').textContent = name;
  // Division first — sets grade options
  document.getElementById('rkDivision').value = rp.division || '';
  rkDivisionChange();
  // Now set grade value (after options are populated)
  document.getElementById('rkGrade').value = rp.grade || '';
  document.getElementById('rkPromotionDate').value = rp.promotionDate || '';
  document.getElementById('rkJoinDate').value = rp.joinDate || '';
  document.getElementById('rkUsjf').value = rp.usjfNum || '';
  document.getElementById('rkUsja').value = rp.usjaNum || '';
  document.getElementById('rkUsaj').value = rp.usajNum || '';
  // Update header badge with saved grade
  document.getElementById('rkProfileBadge').innerHTML = gradeBadge(rp.grade, rp.division, true);
  document.getElementById('rkProfileOverlay').classList.add('show');
}

function rkDivisionChange() {
  var division = document.getElementById('rkDivision').value;
  // Populate grade select based on division
  var grades = division === 'junior' ? JUNIOR_GRADES : (division === 'senior' ? SENIOR_GRADES : []);
  var gradeSelect = document.getElementById('rkGrade');
  gradeSelect.innerHTML = '<option value="">' + (division ? '— not set —' : '— select division first —') + '</option>' +
    grades.map(function(g) { return '<option value="' + g.key + '">' + g.label + '</option>'; }).join('');
  rkGradeChange();
}

function rkGradeChange() {
  var division = document.getElementById('rkDivision').value;
  var grade = document.getElementById('rkGrade').value;
  document.getElementById('rkProfileBadge').innerHTML = gradeBadge(grade, division, true);
}

function rkProfileClose() {
  document.getElementById('rkProfileOverlay').classList.remove('show');
  rkProfileCurrentName = null;
}

function rkProfileSave() {
  if (!rkProfileCurrentName) return;
  var name = rkProfileCurrentName;
  var data = {
    grade:         document.getElementById('rkGrade').value || null,
    division:      document.getElementById('rkDivision').value || null,
    promotionDate: document.getElementById('rkPromotionDate').value || null,
    joinDate:      document.getElementById('rkJoinDate').value || null,
    usjfNum:       document.getElementById('rkUsjf').value.trim(),
    usjaNum:       document.getElementById('rkUsja').value.trim(),
    usajNum:       document.getElementById('rkUsaj').value.trim()
  };
  setRankProfile(name, data);

  // Queue server sync (upsert-dedup)
  var q = getSyncQueue();
  var idx = q.findIndex(function(c) { return c.action === 'saveRankProfile' && c.name === name; });
  var change = { action: 'saveRankProfile', name: name, profile: data };
  if (idx >= 0) q[idx] = change; else q.push(change);
  setSyncQueue(q);

  rkProfileClose();
  rkRender();
  triggerSync();
  showToast('Rank profile saved');
}


// ═══════════════════════════════════
// STATS PAGE
// ═══════════════════════════════════
const BELT_MIN_CLASSES = 30;

var now = new Date();
var stYear = now.getFullYear(), stMonth = now.getMonth();
var stDayDate = new Date();
var stView = 'day', stSort = 'count';

function stGetClassDays(year, month) {
  var days = [], d = new Date(year, month, 1), today = new Date(todayStr() + 'T23:59:59');
  var cancelled = getCancelled();
  while (d.getMonth() === month) {
    var k = fmtDate(d);
    if (CLASS_DAYS.includes(d.getDay()) && d <= today && !cancelled.includes(k)) days.push(k);
    d.setDate(d.getDate() + 1);
  }
  return days;
}

function stCompute(year, month) {
  var att = getAtt(), days = stGetClassDays(year, month), cc = days.length;
  if (!cc) return { cc:0, total:0, avg:0, uniq:0, per:[], daily:[] };
  var sc = {}; var ls = {}; var us = new Set(); var total = 0; var daily = [];
  days.forEach(function(d) {
    var p = att[d]||[]; daily.push({date:d,count:p.length});
    total += p.length;
    p.forEach(function(n) {
      us.add(n); sc[n]=(sc[n]||0)+1;
      if (!ls[n] || d > ls[n]) ls[n] = d;
    });
  });
  var per = Object.entries(sc).map(function(e) {
    return {name:e[0], count:e[1], pct:Math.round(e[1]/cc*100), lastSeen:ls[e[0]]||null};
  });
  return { cc:cc, total:total, avg: Math.round(total/cc*10)/10, uniq:us.size, per:per, daily:daily };
}

function stRender() {
  document.getElementById('stDayBtn').classList.toggle('active', stView==='day');
  document.getElementById('stMonthBtn').classList.toggle('active', stView==='month');
  document.getElementById('stDayFilter').style.display = stView === 'day' ? 'flex' : 'none';

  if (stView === 'day') {
    var label = stDayDate.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'}).toUpperCase();
    document.getElementById('stNavLabel').textContent = label;
    document.getElementById('stNavRange').textContent = '';
    document.getElementById('stNext').disabled = fmtDate(stDayDate) >= todayStr();
    document.getElementById('stPrev').disabled = false;
    stRenderDay();
  } else {
    var label = new Date(stYear, stMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'}).toUpperCase();
    var start = new Date(stYear, stMonth, 1);
    var end = new Date(stYear, stMonth + 1, 0);
    var range = start.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' \u2013 ' + end.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    document.getElementById('stNavLabel').textContent = label;
    document.getElementById('stNavRange').textContent = range;
    var isCur = stYear===now.getFullYear() && stMonth===now.getMonth();
    document.getElementById('stNext').disabled = isCur;
    document.getElementById('stPrev').disabled = false;
    stRenderMonth();
  }
}

function stIsClassDay(d) {
  var cancelled = getCancelled();
  return CLASS_DAYS.includes(d.getDay()) && !cancelled.includes(fmtDate(d));
}

function stNav(dir) {
  if (stView === 'day') {
    var d = new Date(stDayDate);
    var filterOn = document.getElementById('stClassDaysOnly').checked;
    var limit = 0;
    do {
      d.setDate(d.getDate() + dir);
      limit++;
    } while (filterOn && !stIsClassDay(d) && limit < 60);
    stDayDate = d;
  } else {
    stMonth += dir;
    if (stMonth > 11) { stMonth = 0; stYear++; }
    if (stMonth < 0) { stMonth = 11; stYear--; }
  }
  stRender();
}

function dh(v) {
  if (v===null) return '';
  if (v>0) return '<div class="st-card-delta up">\u2191 ' + v + '</div>';
  if (v<0) return '<div class="st-card-delta down">\u2193 ' + Math.abs(v) + '</div>';
  return '<div class="st-card-delta flat">\u2014</div>';
}

function stStudentRows(sorted, totalClasses, opts) {
  if (!opts) opts = {};
  var today = new Date(todayStr() + 'T12:00:00');
  var twoWeeksAgo = new Date(today);
  twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
  var twoWeeksStr = fmtDate(twoWeeksAgo);

  return sorted.map(function(x) {
    var absent = x.lastSeen && x.lastSeen < twoWeeksStr;
    var rowCls = 'st-student-row' + (absent ? ' st-student-row--absent' : '');

    var lsDisplay = '\u2014';
    if (x.lastSeen) {
      var lsDate = new Date(x.lastSeen + 'T12:00:00');
      lsDisplay = lsDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
    }

    var barPct = opts.beltReadiness ? Math.min(100, Math.round(x.count / BELT_MIN_CLASSES * 100)) : x.pct;
    var countLabel = opts.beltReadiness ? x.count + '/' + BELT_MIN_CLASSES : x.count + '/' + totalClasses;
    var pctLabel = (opts.beltReadiness ? barPct : x.pct) + '%';

    return '<div class="' + rowCls + '">' +
      '<div class="st-student-name">' + x.name + '</div>' +
      '<div class="st-bar-wrap"><div class="st-bar-fill" style="width:' + barPct + '%"></div></div>' +
      '<div class="st-student-count">' + countLabel + '</div>' +
      '<div class="st-student-pct">' + pctLabel + '</div>' +
      '<div class="st-student-lastseen">' + lsDisplay + '</div>' +
    '</div>';
  }).join('');
}

function stRenderMonth() {
  var s = stCompute(stYear, stMonth);
  var pm = stMonth-1, py = stYear; if(pm<0){pm=11;py--;}
  var ps = stCompute(py, pm);

  if(!s.cc){ document.getElementById('stContent').innerHTML='<div class="st-empty">No class data for this month yet.</div>'; return; }

  var td = ps.cc>0 ? s.total - ps.total : null;
  var ud = ps.cc>0 ? s.uniq - ps.uniq : null;
  var cd = ps.cc>0 ? s.cc - ps.cc : null;
  var ad = ps.cc>0 ? Math.round((s.avg-ps.avg)*10)/10 : null;

  var sorted = s.per.slice();
  if (stSort === 'count') {
    sorted.sort(function(a,b) { return b.count - a.count; });
  } else if (stSort === 'name') {
    sorted.sort(function(a,b) { return a.name.localeCompare(b.name); });
  } else {
    sorted.sort(function(a,b) {
      if (!a.lastSeen && !b.lastSeen) return 0;
      if (!a.lastSeen) return 1;
      if (!b.lastSeen) return -1;
      return b.lastSeen.localeCompare(a.lastSeen);
    });
  }

  var mx = Math.max.apply(null, s.daily.map(function(d){return d.count;}).concat([1]));
  var bars = s.daily.map(function(d){
    var h = Math.max(4,(d.count/mx)*100);
    var l = new Date(d.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',day:'numeric'});
    return '<div class="st-bar" style="height:'+h+'%" data-tip="'+l+': '+d.count+'"></div>';
  }).join('');
  var labels = s.daily.map(function(d,i){
    if(s.daily.length>8&&i%2!==0)return'<div class="st-label"></div>';
    return'<div class="st-label">'+new Date(d.date+'T12:00:00').getDate()+'</div>';
  }).join('');

  document.getElementById('stContent').innerHTML =
    '<div class="st-cards">' +
      '<div class="st-card"><div class="st-card-label">Total Check-ins</div><div class="st-card-value">'+s.total+'</div>'+dh(td)+'</div>' +
      '<div class="st-card"><div class="st-card-label">Students</div><div class="st-card-value">'+s.uniq+'</div>'+dh(ud)+'</div>' +
      '<div class="st-card"><div class="st-card-label">Classes Held</div><div class="st-card-value">'+s.cc+'</div>'+dh(cd)+'</div>' +
      '<div class="st-card"><div class="st-card-label">Avg Class Size</div><div class="st-card-value">'+s.avg+'</div>'+dh(ad)+'</div>' +
    '</div>' +
    '<div class="st-trend">' +
      '<div class="st-section-title">Attendance by class</div>' +
      '<div class="st-chart">'+bars+'</div>' +
      '<div class="st-labels">'+labels+'</div>' +
    '</div>' +
    '<div class="st-table">' +
      '<div class="st-table-header">' +
        '<div class="st-section-title st-section-title--inline">Per student ('+sorted.length+')</div>' +
        '<button class="st-sort-btn" onclick="stToggleSort()">Sort: '+stSortLabel()+'</button>' +
      '</div>' +
      stStudentRows(sorted, s.cc) +
    '</div>';
}

function stRenderDay() {
  var att = getAtt();
  var dateStr = fmtDate(stDayDate);
  var cancelled = getCancelled();
  var isClassDay = CLASS_DAYS.includes(stDayDate.getDay());

  if (!isClassDay || cancelled.includes(dateStr)) {
    document.getElementById('stContent').innerHTML = '<div class="st-empty">No class on this day.</div>';
    return;
  }

  var names = att[dateStr];
  if (!names || names.length === 0) {
    document.getElementById('stContent').innerHTML = '<div class="st-empty">No sign-in data for this class.</div>';
    return;
  }

  // Month context — how many classes has each student attended this month so far
  var monthStats = stCompute(stDayDate.getFullYear(), stDayDate.getMonth());
  var monthCountMap = {};
  monthStats.per.forEach(function(p) { monthCountMap[p.name] = p.count; });

  var sorted = names.slice().sort(function(a, b) { return a.localeCompare(b); });
  var rows = sorted.map(function(name) {
    var mc = monthCountMap[name] || 1;
    var monthLabel = mc + ' this month';
    return '<div class="st-student-row">' +
      '<div class="st-student-name">' + name + '</div>' +
      '<div class="st-student-lastseen">' + monthLabel + '</div>' +
    '</div>';
  }).join('');

  document.getElementById('stContent').innerHTML =
    '<div class="st-cards">' +
      '<div class="st-card"><div class="st-card-label">Attended</div><div class="st-card-value">' + names.length + '</div></div>' +
      '<div class="st-card"><div class="st-card-label">Classes This Month</div><div class="st-card-value">' + monthStats.cc + '</div></div>' +
    '</div>' +
    '<div class="st-table">' +
      '<div class="st-table-header">' +
        '<div class="st-section-title st-section-title--inline">Who was there (' + sorted.length + ')</div>' +
      '</div>' +
      rows +
    '</div>';
}

function stSetView(v) { stView = v; stRender(); }
function stToggleSort() {
  if (stSort === 'count') stSort = 'name';
  else if (stSort === 'name') stSort = 'lastseen';
  else stSort = 'count';
  stRender();
}
function stSortLabel() {
  if (stSort === 'count') return '# classes';
  if (stSort === 'name') return 'name';
  return 'last seen';
}

// ═══════════════════════════════════
// DUES PAGE
// ═══════════════════════════════════
var DUES_KEY = 'dojo_dues';
var duYear = new Date().getFullYear();
var duMonth = new Date().getMonth(); // 0-indexed

function getDues() {
  try { return JSON.parse(localStorage.getItem(DUES_KEY) || '{}'); }
  catch (e) { return {}; }
}
function setDues(d) {
  try { localStorage.setItem(DUES_KEY, JSON.stringify(d)); }
  catch (e) {}
}

function duMonthKey(y, m) {
  return y + '-' + String(m + 1).padStart(2, '0');
}

function duesRender() {
  var mk = duMonthKey(duYear, duMonth);
  var label = new Date(duYear, duMonth).toLocaleDateString('en-US', {month:'long', year:'numeric'}).toUpperCase();
  document.getElementById('duNavLabel').textContent = label;

  var isNow = duYear === new Date().getFullYear() && duMonth === new Date().getMonth();
  document.getElementById('duNext').disabled = isNow;

  // Load toggle state
  var enabled = localStorage.getItem('deleon_dues_enabled') !== 'false';
  document.getElementById('duesEnabledToggle').checked = enabled;

  var roster = getRoster();
  var dues = getDues();
  var monthDues = dues[mk] || {};

  if (!roster.length) {
    document.getElementById('duContent').innerHTML = '<div class="st-empty">No students on roster.</div>';
    return;
  }

  // Count paid
  var paidCount = 0;
  roster.forEach(function(name) {
    if (monthDues[name] && monthDues[name].paid) paidCount++;
  });
  var pct = Math.round(paidCount / roster.length * 100);

  // Calculate consecutive unpaid months per student
  function getConsecutiveUnpaid(name) {
    var count = 0;
    var y = new Date().getFullYear();
    var m = new Date().getMonth();
    for (var i = 0; i < 12; i++) {
      m--;
      if (m < 0) { m = 11; y--; }
      var k = duMonthKey(y, m);
      var md = dues[k] || {};
      if (md[name] && md[name].paid) break;
      count++;
    }
    return count;
  }

  // Build rows
  var rows = roster.map(function(name) {
    var entry = monthDues[name];
    var paid = entry && entry.paid;
    var dateStr = '';
    if (paid && entry.date) {
      var d = new Date(entry.date + 'T12:00:00');
      dateStr = d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    }
    var overdue = 0;
    if (!paid) overdue = getConsecutiveUnpaid(name);

    return '<div class="du-row" onclick="duToggle(\'' + name.replace(/'/g, "\\'") + '\')">' +
      '<div class="du-name">' + name + '</div>' +
      (overdue > 1 ? '<div class="du-overdue">' + overdue + 'mo overdue</div>' : '') +
      '<div class="du-badge ' + (paid ? 'du-badge--paid' : 'du-badge--unpaid') + '">' + (paid ? 'Paid' : 'Unpaid') + '</div>' +
      (dateStr ? '<div class="du-date">' + dateStr + '</div>' : '') +
    '</div>';
  }).join('');

  document.getElementById('duContent').innerHTML =
    '<div class="du-summary">' +
      '<div class="du-summary-text">' + paidCount + ' of ' + roster.length + ' paid</div>' +
      '<div class="du-summary-bar"><div class="du-summary-fill" style="width:' + pct + '%"></div></div>' +
    '</div>' +
    '<div class="du-list">' + rows + '</div>';
}

function duNav(dir) {
  duMonth += dir;
  if (duMonth > 11) { duMonth = 0; duYear++; }
  if (duMonth < 0) { duMonth = 11; duYear--; }
  duesRender();
}

function duToggle(name) {
  var mk = duMonthKey(duYear, duMonth);
  var dues = getDues();
  if (!dues[mk]) dues[mk] = {};
  var entry = dues[mk][name];
  var nowPaid = !(entry && entry.paid);
  dues[mk][name] = {
    paid: nowPaid,
    date: nowPaid ? todayStr() : '',
    source: 'admin'
  };
  setDues(dues);
  queueChange({
    action: 'toggleDues',
    name: name,
    month: mk,
    paid: nowPaid,
    date: todayStr()
  });
  triggerSync();
  duesRender();
}

// Toggle handler
document.getElementById('duesEnabledToggle').addEventListener('change', function() {
  var enabled = this.checked;
  localStorage.setItem('deleon_dues_enabled', enabled ? 'true' : 'false');
  queueChange({
    action: 'setSetting',
    settingKey: 'duesEnabled',
    settingValue: enabled ? 'true' : 'false'
  });
  triggerSync();
});

// ═══════════════════════════════════
// EVENT LISTENERS
// ═══════════════════════════════════
document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'hidden') {
    flushSyncQueue().catch(function() {});
  }
});

window.addEventListener('online', function() {
  flushSyncQueue().then(function(success) {
    if (success) {
      lastSavedTime = new Date();
      setSyncState('saved', 'Synced ' + formatSavedTime(lastSavedTime));
    }
  }).catch(function() {});
});

// ═══════════════════════════════════
// INIT
// ═══════════════════════════════════
siInit();
document.getElementById('siSyncVersion').textContent = APP_VERSION;

document.getElementById('siSyncRefresh').addEventListener('click', function() {
  var btn = this;
  btn.classList.add('spinning');
  loadFromServer().then(function() {
    stRender();
    btn.classList.remove('spinning');
  }).catch(function() {
    btn.classList.remove('spinning');
  });
});
if (isUnlocked()) {
  document.getElementById('pinScreen').classList.add('hidden');
  siRender();
} else {
  showPin();
}

loadFromServer();
flushSyncQueue().then(function(success) {
  if (success && getSyncQueue().length === 0) {
    lastSavedTime = new Date();
    setSyncState('saved', 'Synced ' + formatSavedTime(lastSavedTime));
  }
}).catch(function() {});

// ═══════════════════════════════════
// PULL TO REFRESH
// ═══════════════════════════════════
(function() {
  var ptrEl = document.getElementById('ptr');
  var startY = 0;
  var pulling = false;
  var threshold = 60;

  document.addEventListener('touchstart', function(e) {
    if (window.scrollY > 0) return;
    if (!document.getElementById('pinScreen').classList.contains('hidden')) return;
    if (document.getElementById('roAddOverlay').classList.contains('show')) return;
    if (document.getElementById('roStatusOverlay').classList.contains('show')) return;
    if (document.getElementById('rkProfileOverlay').classList.contains('show')) return;
    if (document.getElementById('modalOverlay').classList.contains('show')) return;
    startY = e.touches[0].clientY;
    pulling = true;
  }, { passive: true });

  document.addEventListener('touchmove', function(e) {
    if (!pulling) return;
    var dy = e.touches[0].clientY - startY;
    if (dy > 0 && window.scrollY === 0) {
      var progress = Math.min(dy / threshold, 1);
      ptrEl.querySelector('.ptr__indicator').style.transform = 'translateY(' + (-50 + 66 * progress) + 'px)';
    }
  }, { passive: true });

  document.addEventListener('touchend', function() {
    if (!pulling) return;
    pulling = false;
    var indicator = ptrEl.querySelector('.ptr__indicator');
    var currentY = parseFloat(indicator.style.transform.replace(/[^-\d.]/g, '')) || -50;
    if (currentY > 10) {
      ptrEl.classList.add('ptr--loading');
      indicator.style.transform = '';
      flushSyncQueue().then(function() {
        return loadFromServer();
      }).then(function() {
        setTimeout(function() {
          ptrEl.classList.remove('ptr--loading');
        }, 500);
      }).catch(function() {
        ptrEl.classList.remove('ptr--loading');
      });
    } else {
      indicator.style.transform = '';
    }
  });
})();

// ── CSV Export ───────────────────────────────────────────
function exportAttendanceCSV() {
  var att = getAtt();
  var dates = Object.keys(att).sort();
  if (!dates.length) { alert('No attendance data to export yet.'); return; }
  var rows = [['Date', 'Students Present', 'Count']];
  dates.forEach(function(d) {
    var names = Array.isArray(att[d]) ? att[d] : [];
    rows.push([d, names.join('; '), names.length]);
  });
  var csv = rows.map(function(r) {
    return r.map(function(c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(',');
  }).join('\n');
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'deleon-attendance-' + new Date().toISOString().slice(0, 10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Auto-refresh every 60 seconds so admin stays current
setInterval(function() {
  if (document.visibilityState === 'visible' && navigator.onLine) {
    loadFromServer();
  }
}, 60 * 1000);

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function(err) {
    console.warn('Service worker registration failed:', err);
  });
}
</script>
</body>
</html>
